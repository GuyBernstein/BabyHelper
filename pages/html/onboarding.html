<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="Technology information">
    <meta name="author" content="Guy Bernstein">
    <meta name="image" property="og:image" content="../media/onboarding_screenshots/setup-complete.png">
    <meta name="title" property="og:title" content="Welcome to BabyHelper - Onboarding">
    <title>Welcome to BabyHelper - Onboarding</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700&family=Lora:wght@400;500;600&display=swap"
          rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            lightest: '#fdf6f0',
                            light: '#ffe8d9',
                            primary: '#ff8c69',
                            primaryHover: '#ff7043',
                            secondary: '#ffd8cc',
                            accent1: '#ffb5a7',
                            accent2: '#fec89a',
                            text: '#6d5d52',
                            textLight: '#938278',
                            heading: '#5c4d44'
                        }
                    },
                    fontFamily: {
                        sans: ['Nunito Sans', 'sans-serif'],
                        serif: ['Lora', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Step transition animations */
        .step-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .step-hidden {
            display: none;
        }

        .step-inactive {
            opacity: 0;
            transform: translateX(20px);
        }

        .progress-segment {
            transition: background-color 0.3s ease;
        }

        /* Toast animations */
        .toast-enter {
            animation: slideIn 0.3s ease-out;
        }

        .toast-exit {
            animation: slideOut 0.3s ease-in;
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid rgba(255, 140, 105, 0.2);
            border-top-color: #ff8c69;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Slide down animation for checkbox container */
        .slide-down-enter {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal animations */
        .modal-enter {
            animation: modalFadeIn 0.3s ease-out;
        }

        .modal-enter .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-exit {
            animation: modalFadeOut 0.2s ease-in;
        }

        .modal-exit .modal-content {
            animation: modalSlideOut 0.2s ease-in;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
        }

        /* Flow section transitions */
        .flow-section {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card hover effects */
        .baby-card {
            transition: all 0.3s ease;
        }

        .baby-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Progress indicator styles */
        .progress-step {
            position: relative;
            flex: 1;
            text-align: center;
        }

        .progress-step::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #ffe8d9;
            z-index: -1;
        }

        .progress-step:last-child::after {
            display: none;
        }

        .progress-step.active::after {
            background: #ff8c69;
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            border-radius: 50%;
            background: #ffe8d9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .progress-step.active .progress-step-circle {
            background: #ff8c69;
            color: white;
        }

        .progress-step.completed .progress-step-circle {
            background: #10b981;
            color: white;
        }

        /* Enhanced form styles */
        .form-group {
            position: relative;
        }

        .form-group label {
            transition: all 0.2s ease;
        }

        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label {
            transform: translateY(-20px) scale(0.85);
            color: #ff8c69;
        }

        /* Invitation card animations */
        .invitation-card {
            transition: all 0.3s ease;
        }

        .invitation-card.processing {
            opacity: 0.6;
            pointer-events: none;
        }

        .invitation-card.accepted {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .invitation-card.declined {
            opacity: 0.5;
        }

        /* Modal backdrop blur */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        /* Success animation */
        @keyframes successPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .success-icon {
            animation: successPulse 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-pastel-lightest font-sans text-pastel-text min-h-screen">
<!-- Header -->
<nav class="w-full py-4 px-4 md:px-8 bg-white shadow-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <a href="#" class="flex items-center space-x-2">
            <div class="w-10 h-10 rounded-full bg-pastel-primary flex items-center justify-center text-white font-serif font-semibold text-xl">
                B
            </div>
            <span class="font-serif text-pastel-heading text-xl">BabyHelper</span>
        </a>
        <div class="flex items-center space-x-4">
            <img id="userPicture" class="w-10 h-10 rounded-full" alt="User profile">
            <button onclick="onboardingApp.logout()"
                    class="text-sm text-pastel-textLight hover:text-pastel-primary transition-colors">Logout
            </button>
        </div>
    </div>
</nav>

<!-- Onboarding Structure -->
<!-- Main Content Container -->
<div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Welcome Section (remains the same) -->
    <div class="text-center mb-8">
        <h1 class="font-serif text-4xl md:text-5xl font-medium text-pastel-heading mb-4">
            Welcome to BabyHelper, <span id="userName" class="text-pastel-primary">Parent</span>!
        </h1>
        <p class="text-lg text-pastel-textLight">
            Let's get your account set up in just a few steps
        </p>
        <p class="text-sm text-pastel-textLight mt-2">
            Signed in as: <span id="userEmail" class="font-medium"></span>
        </p>
    </div>

    <!-- Dynamic Progress Indicator -->
    <div id="progress-indicator" class="mb-8 hidden">
        <!-- This will be dynamically populated based on the current flow state -->
    </div>

    <!-- Dynamic Content Area -->
    <div id="dynamic-content" class="min-h-[400px]">
        <!-- Content will be dynamically loaded here based on flow state -->
        <div class="text-center py-16">
            <div class="inline-flex items-center space-x-2">
                <div class="spinner w-8 h-8"></div>
                <span class="text-pastel-textLight text-lg">Loading your setup...</span>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50"></div>
<script>
    /**
     * BabyHelper Onboarding Application
     *
     * This Application implements:
     * - Modular architecture with clear separation of concerns
     * - Comprehensive error handling with user-friendly feedback
     * - XSS prevention through consistent HTML escaping
     * - Retry functionality for network operations
     * - Input validation and sanitization
     * - Reusable UI components and utilities
     */

        // Namespace for the application to avoid global scope pollution
    const onboardingApp = (function () {
            'use strict';

            // ============================================================================
            // Constants and Configuration
            // ============================================================================

            const CONFIG = {
                API_TIMEOUT: 30000, // 30 seconds
                RETRY_ATTEMPTS: 3,
                RETRY_DELAY: 1000, // 1 second
                TOAST_DURATION: 3000, // 3 seconds
                MIN_PASSWORD_LENGTH: 8,
                MAX_NAME_LENGTH: 100,
                MAX_EMAIL_LENGTH: 255,
                BABY_WEIGHT_MIN: 0.5,
                BABY_WEIGHT_MAX: 50,
                BABY_HEIGHT_MIN: 20,
                BABY_HEIGHT_MAX: 150
            };

            const STATES = {
                LOADING: 'loading',
                EMPTY: 'empty',
                LOADED: 'loaded',
                ERROR: 'error',
                SAVING: 'saving',
                SAVED: 'saved'
            };

            const MESSAGE_TYPES = {
                SUCCESS: 'success',
                ERROR: 'error',
                WARNING: 'warning',
                INFO: 'info'
            };

            // ============================================================================
            // State Management
            // ============================================================================

            const state = {
                currentStep: 1,
                totalSteps: 3,
                isLoading: false,
                retryCounters: {},
                data: {
                    babyInfo: {},
                    coParents: [],
                    acceptedInvitations: []
                },
                flowState: null,
                pendingInvitations: [],
                invitedBabyNames: [],
                acceptedInvitations: []
            };

            // ============================================================================
            // Utility Functions
            // ============================================================================

            const utils = {
                    /**
                     * Escape HTML to prevent XSS attacks
                     * @param {string} unsafe - Unsafe string
                     * @returns {string} Safe HTML string
                     */
                    escapeHtml(unsafe) {
                        if (typeof unsafe !== 'string') return '';
                        const div = document.createElement('div');
                        div.textContent = unsafe;
                        return div.innerHTML;
                    },

                    /**
                     * Validate email format (Gmail only)
                     * @param {string} email - Email to validate
                     * @returns {boolean} Is valid Gmail address
                     */
                    isValidGmail(email) {
                        const gmailRegex = /^[a-zA-Z0-9.+_-]+@gmail\.com$/;
                        return gmailRegex.test(email);
                    },

                    /**
                     * Validate date is not in the future
                     * @param {string} dateString - Date string
                     * @returns {boolean} Is valid date
                     */
                    isValidBirthdate(dateString) {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return false;

                        // Get today in YYYY-MM-DD format for comparison
                        const today = new Date();
                        const todayStr = today.getFullYear() + '-' +
                            String(today.getMonth() + 1).padStart(2, '0') + '-' +
                            String(today.getDate()).padStart(2, '0');

                        // Convert input date to YYYY-MM-DD format
                        const inputDateStr = date.getFullYear() + '-' +
                            String(date.getMonth() + 1).padStart(2, '0') + '-' +
                            String(date.getDate()).padStart(2, '0');

                        // Compare date strings to avoid timezone issues
                        return inputDateStr <= todayStr;
                    },

                    /**
                     * Format date to YYYY-MM-DD
                     * @param {string} dateString - Date in any format
                     * @returns {string} Formatted date
                     */
                    formatDateForAPI(dateString) {
                        const date = new Date(dateString);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                    ,

                    /**
                     * Format date for display
                     * @param {string} dateString - Date string
                     * @returns {string} Formatted date
                     */
                    formatDateForDisplay(dateString) {
                        try {
                            const date = new Date(dateString);
                            return date.toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                            });
                        } catch (e) {
                            return 'Invalid date';
                        }
                    }
                    ,

                    /**
                     * Debounce function to limit execution frequency
                     * @param {Function} func - Function to debounce
                     * @param {number} wait - Wait time in milliseconds
                     * @returns {Function} Debounced function
                     */
                    debounce(func, wait) {
                        let timeout;
                        return function executedFunction(...args) {
                            const later = () => {
                                clearTimeout(timeout);
                                func(...args);
                            };
                            clearTimeout(timeout);
                            timeout = setTimeout(later, wait);
                        };
                    }
                    ,

                    /**
                     * Sleep for specified milliseconds
                     * @param {number} ms - Milliseconds to sleep
                     * @returns {Promise} Promise that resolves after delay
                     */
                    sleep(ms) {
                        return new Promise(resolve => setTimeout(resolve, ms));
                    }
                }
            ;

            // ============================================================================
            // API Communication Layer
            // ============================================================================

            const api = {
                /**
                 * Get authentication token
                 * @returns {string|null} Auth token
                 */
                getAuthToken() {
                    return sessionStorage.getItem('idToken') || window.authToken || null;
                },

                /**
                 * Get API headers with authentication
                 * @returns {Object} Headers object
                 */
                getHeaders() {
                    const token = this.getAuthToken();
                    if (!token) {
                        throw new Error('No authentication token found');
                    }
                    return {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    };
                },

                /**
                 * Parse error response from API
                 * @param {Response} response - Fetch response
                 * @returns {Promise<string>} Error message
                 */
                async parseErrorResponse(response) {
                    let errorMessage = `Request failed (${response.status})`;

                    try {
                        const errorData = await response.json();

                        if (errorData.detail) {
                            if (typeof errorData.detail === 'string') {
                                errorMessage = errorData.detail;
                            } else if (Array.isArray(errorData.detail)) {
                                errorMessage = errorData.detail
                                    .map(err => {
                                        const field = err.loc?.[err.loc.length - 1] || 'field';
                                        return `${field}: ${err.msg}`;
                                    })
                                    .join(', ');
                            }
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }

                    return errorMessage;
                },

                /**
                 * Make authenticated API request with retry
                 * @param {string} url - API endpoint
                 * @param {Object} options - Fetch options
                 * @returns {Promise<Response>} API response
                 */
                async request(url, options = {}) {
                    const retryKey = `${options.method || 'GET'}_${url}`;
                    state.retryCounters[retryKey] = state.retryCounters[retryKey] || 0;

                    for (let attempt = 0; attempt < CONFIG.RETRY_ATTEMPTS; attempt++) {
                        try {
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);

                            const response = await fetch(url, {
                                ...options,
                                headers: {
                                    ...this.getHeaders(),
                                    ...options.headers
                                },
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            // Handle authentication errors
                            if (response.status === 401 || response.status === 403) {
                                sessionStorage.clear();
                                window.location.href = '/auth/login';
                                throw new Error('Authentication expired');
                            }

                            // Reset retry counter on success
                            if (response.ok) {
                                state.retryCounters[retryKey] = 0;
                            }

                            return response;

                        } catch (error) {
                            state.retryCounters[retryKey]++;

                            // Don't retry on authentication errors
                            if (error.message === 'Authentication expired') {
                                throw error;
                            }

                            // Last attempt or non-retryable error
                            if (attempt === CONFIG.RETRY_ATTEMPTS - 1 ||
                                error.name === 'AbortError') {
                                throw error;
                            }

                            // Wait before retry with exponential backoff
                            await utils.sleep(CONFIG.RETRY_DELAY * Math.pow(2, attempt));
                        }
                    }
                },

                /**
                 * API endpoints
                 */
                endpoints: {
                    async createBaby(data) {
                        const response = await api.request('/baby/', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    },

                    async sendCoparentInvite(data) {
                        const response = await api.request('/coparent/invite/', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    },

                    async getPendingInvitations() {
                        const response = await api.request('/coparent/invitations/', {
                            method: 'GET'
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    },

                    async respondToInvitation(invitationId, accept) {
                        const response = await api.request(`/coparent/invitations/${invitationId}`, {
                            method: 'POST',
                            body: JSON.stringify({invitation_id: invitationId, accept})
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    },

                    async removeNotification(notificationId) {
                        const response = await api.request(`/notifications/${notificationId}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    },

                    async markNotificationAsRead(notificationId) {
                        const response = await api.request(`/notifications/${notificationId}/read`, {
                            method: 'PUT'
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    },

                    async updateUserPreference(data) {
                        const response = await api.request('/auth/me/preferences', {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                        if (!response.ok) {
                            const error = await api.parseErrorResponse(response);
                            throw new Error(error);
                        }
                        return response.json();
                    }
                }
            };

            // ============================================================================
            // UI Components and Updates
            // ============================================================================

            const ui = {
                /**
                 * Show loading state on button
                 * @param {string} buttonId - Button element ID
                 * @param {boolean} isLoading - Loading state
                 */
                setButtonLoading(buttonId, isLoading) {
                    const button = document.getElementById(buttonId);
                    if (!button) return;

                    const spinner = button.querySelector('.spinner');
                    const text = button.querySelector('span');

                    if (isLoading) {
                        button.disabled = true;
                        if (spinner) spinner.classList.remove('hidden');
                        if (text) text.textContent = 'Loading...';
                    } else {
                        button.disabled = false;
                        if (spinner) spinner.classList.add('hidden');
                        if (text) {
                            // Reset to original text
                            switch (buttonId) {
                                case 'step1-submit':
                                    text.textContent = 'Next Step';
                                    break;
                                case 'invite-submit':
                                    text.textContent = 'Send Invite';
                                    break;
                                case 'complete-button':
                                    text.textContent = 'Complete Setup';
                                    break;
                            }
                        }
                    }
                },

                /**
                 * Show field error
                 * @param {string} fieldId - Field element ID
                 * @param {string} message - Error message
                 */
                showFieldError(fieldId, message) {
                    const field = document.getElementById(fieldId);
                    const errorEl = document.getElementById(`${fieldId}-error`);

                    if (field) {
                        field.classList.add('border-red-500');
                        field.classList.remove('border-pastel-light');
                    }

                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.classList.remove('hidden');
                    }
                },

                /**
                 * Clear field error
                 * @param {string} fieldId - Field element ID
                 */
                clearFieldError(fieldId) {
                    const field = document.getElementById(fieldId);
                    const errorEl = document.getElementById(`${fieldId}-error`);

                    if (field) {
                        field.classList.remove('border-red-500');
                        field.classList.add('border-pastel-light');
                    }

                    if (errorEl) {
                        errorEl.classList.add('hidden');
                        errorEl.textContent = '';
                    }
                },

                /**
                 * Clear all field errors in a form
                 * @param {string} formId - Form element ID
                 */
                clearFormErrors(formId) {
                    const form = document.getElementById(formId);
                    if (!form) return;

                    // Clear all field errors
                    form.querySelectorAll('input, select').forEach(field => {
                        this.clearFieldError(field.id);
                    });

                    // Clear step error
                    const stepError = form.closest('.step-container')?.querySelector('[id$="-error"]');
                    if (stepError) {
                        stepError.classList.add('hidden');
                        stepError.querySelector('p').textContent = '';
                    }
                },

                /**
                 * Show toast notification
                 * @param {string} message - Message to display
                 * @param {string} type - Message type (success, error, warning, info)
                 */
                showToast(message, type = MESSAGE_TYPES.SUCCESS) {
                    const container = document.getElementById('toast-container');
                    if (!container) return;

                    const toast = document.createElement('div');
                    const bgColors = {
                        [MESSAGE_TYPES.SUCCESS]: 'bg-green-600',
                        [MESSAGE_TYPES.ERROR]: 'bg-red-600',
                        [MESSAGE_TYPES.WARNING]: 'bg-yellow-600',
                        [MESSAGE_TYPES.INFO]: 'bg-pastel-primary'
                    };

                    toast.className = `${bgColors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 toast-enter`;
                    toast.textContent = message;

                    container.appendChild(toast);

                    // Remove after duration
                    setTimeout(() => {
                        toast.classList.add('toast-exit');
                        setTimeout(() => toast.remove(), 300);
                    }, CONFIG.TOAST_DURATION);
                },

                /**
                 * Update progress bar
                 * @param {number} step - Current step
                 */
                updateProgressBar(step) {
                    for (let i = 1; i <= state.totalSteps; i++) {
                        const segment = document.getElementById(`progress-${i}`);
                        if (segment) {
                            if (i <= step) {
                                segment.classList.add('bg-pastel-primary');
                                segment.classList.remove('bg-pastel-light');
                            } else {
                                segment.classList.remove('bg-pastel-primary');
                                segment.classList.add('bg-pastel-light');
                            }
                        }
                    }
                },

                /**
                 * Update invitation list display
                 */
                updateInvitationsList() {
                    const listContainer = document.getElementById('invitedList');
                    const invitationsList = document.getElementById('invitationsList');

                    if (!listContainer || !invitationsList) return;

                    if (state.data.coParents.length > 0) {
                        listContainer.classList.remove('hidden');
                        invitationsList.innerHTML = state.data.coParents
                            .map(item => {
                                if (typeof item === 'string') {
                                    // Handle legacy format
                                    return this.createInvitationItemHTML(item, null);
                                }
                                return this.createInvitationItemHTML(item.email, item.notificationId);
                            })
                            .join('');
                    } else {
                        listContainer.classList.add('hidden');
                    }
                },

                /**
                 * Create HTML for invitation list item
                 * @param {string} email - Invitee email
                 * @param notificationId
                 * @returns {string} HTML string
                 */
                createInvitationItemHTML(email, notificationId) {
                    const safeEmail = utils.escapeHtml(email);
                    const safeId = parseInt(notificationId, 10) || 0;
                    return `
                        <div class="p-3 bg-pastel-lightest rounded-lg flex justify-between items-center"
                             data-notification-id="${safeId}">
                            <span class="text-sm text-pastel-text">${safeEmail}</span>
                            ${safeId ? `
                                <button onclick="onboardingApp.removeInvitation(${safeId})"
                                        class="text-xs text-red-500 hover:text-red-700 font-medium transition-colors">
                                    Remove
                                </button>
                            ` : ''}
                        </div>
                    `;
                },

                /**
                 * Create HTML for pending invitation
                 * @param {Object} invitation - Invitation data
                 * @returns {string} HTML string
                 */
                createPendingInvitationHTML(invitation) {
                    const safe = {
                        inviterName: utils.escapeHtml(invitation.inviter_name || 'Unknown'),
                        inviterEmail: utils.escapeHtml(invitation.inviter_email),
                        babyName: utils.escapeHtml(invitation.baby_name),
                        createdAt: utils.formatDateForDisplay(invitation.created_at),
                        invitationId: parseInt(invitation.invitation_id, 10)
                    };

                    return `
                    <div class="border border-pastel-light rounded-lg p-4 space-y-3"
                         data-invitation-id="${safe.invitationId}">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-pastel-heading">${safe.inviterName}</h4>
                                <p class="text-sm text-pastel-textLight">${safe.inviterEmail}</p>
                            </div>
                            <span class="text-xs text-pastel-textLight">${safe.createdAt}</span>
                        </div>
                        <p class="text-sm text-pastel-text">
                            Invites you to be a co-parent for
                            <span class="font-medium">${safe.babyName}</span>
                        </p>
                        <div class="flex space-x-2">
                            <button onclick="onboardingApp.respondToInvitation(${safe.invitationId}, true)"
                                    class="invitation-accept px-4 py-2 bg-pastel-primary text-white text-sm font-medium rounded-lg hover:bg-pastel-primaryHover transition-colors">
                                Accept
                            </button>
                            <button onclick="onboardingApp.respondToInvitation(${safe.invitationId}, false)"
                                    class="invitation-decline px-4 py-2 border border-pastel-light text-pastel-text text-sm font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                                Decline
                            </button>
                        </div>
                    </div>
                `;
                },

                /**
                 * Set invitation display state
                 * @param {Object} elements - DOM elements
                 * @param {string} displayState - Display state
                 */
                setInvitationState(elements, displayState) {
                    Object.values(elements).forEach(el => el?.classList.add('hidden'));

                    switch (displayState) {
                        case STATES.LOADING:
                            elements.loading?.classList.remove('hidden');
                            break;
                        case STATES.EMPTY:
                        case STATES.ERROR:
                            elements.noInvitations?.classList.remove('hidden');
                            break;
                        case STATES.LOADED:
                            elements.invitations?.classList.remove('hidden');
                            break;
                    }
                }
            };

            // ============================================================================
            // Form Validation
            // ============================================================================

            const validation = {
                /**
                 * Validate baby information form
                 * @returns {Object} Validation result with isValid and errors
                 */
                validateBabyInfo() {
                    const errors = {};
                    let isValid = true;

                    // Clear previous errors
                    ui.clearFormErrors('babyInfoForm');

                    // Name validation
                    const name = document.getElementById('babyName').value.trim();
                    if (!name) {
                        errors.babyName = 'Baby name is required';
                        isValid = false;
                    } else if (name.length > CONFIG.MAX_NAME_LENGTH) {
                        errors.babyName = `Name must be less than ${CONFIG.MAX_NAME_LENGTH} characters`;
                        isValid = false;
                    } else if (!/^[a-zA-Z\s'-]+$/.test(name)) {
                        errors.babyName = 'Name can only contain letters, spaces, hyphens, and apostrophes';
                        isValid = false;
                    }

                    // Date of birth validation
                    const dob = document.getElementById('babyDob').value;
                    if (!dob) {
                        errors.babyDob = 'Date of birth is required';
                        isValid = false;
                    } else if (!utils.isValidBirthdate(dob)) {
                        errors.babyDob = 'Please enter a valid date not in the future';
                        isValid = false;
                    }

                    // Gender validation
                    const gender = document.getElementById('babyGender').value;
                    if (!gender) {
                        errors.babyGender = 'Please select a gender';
                        isValid = false;
                    }

                    // Weight validation
                    const weight = document.getElementById('babyWeight').value;
                    if (!weight) {
                        errors.babyWeight = 'Weight is required';
                        isValid = false;
                    } else if (isNaN(weight) || weight < CONFIG.BABY_WEIGHT_MIN || weight > CONFIG.BABY_WEIGHT_MAX) {
                        errors.babyWeight = `Weight must be between ${CONFIG.BABY_WEIGHT_MIN} and ${CONFIG.BABY_WEIGHT_MAX} kg`;
                        isValid = false;
                    }

                    // Height validation
                    const height = document.getElementById('babyHeight').value;
                    if (!height) {
                        errors.babyHeight = 'Height is required';
                        isValid = false;
                    } else if (isNaN(height) || height < CONFIG.BABY_HEIGHT_MIN || height > CONFIG.BABY_HEIGHT_MAX) {
                        errors.babyHeight = `Height must be between ${CONFIG.BABY_HEIGHT_MIN} and ${CONFIG.BABY_HEIGHT_MAX} cm`;
                        isValid = false;
                    }

                    // Show errors
                    Object.entries(errors).forEach(([field, message]) => {
                        ui.showFieldError(field, message);
                    });

                    return {isValid, errors};
                },

                /**
                 * Validate co-parent email
                 * @returns {Object} Validation result
                 */
                validateCoparentEmail() {
                    const email = document.getElementById('coParentEmail').value.trim();
                    const userEmail = sessionStorage.getItem('userEmail');

                    ui.clearFieldError('coParentEmail');

                    if (!email) {
                        const error = 'Please enter an email address';
                        ui.showFieldError('coParentEmail', error);
                        return {isValid: false, error};
                    }

                    if (email === userEmail) {
                        const error = 'You cannot invite yourself';
                        ui.showFieldError('coParentEmail', error);
                        return {isValid: false, error};
                    }

                    if (!utils.isValidGmail(email)) {
                        const error = 'Please enter a valid Gmail address';
                        ui.showFieldError('coParentEmail', error);
                        return {isValid: false, error};
                    }

                    // Check if already invited
                    const alreadyInvited = state.data.coParents.some(item => {
                        return typeof item === 'string' ? item === email : item.email === email;
                    });

                    if (alreadyInvited) {
                        const error = 'This person has already been invited';
                        ui.showFieldError('coParentEmail', error);
                        return {isValid: false, error};
                    }

                    return {isValid: true};
                }
            };

            // ============================================================================
            // Step Management
            // ============================================================================

            const steps = {
                /**
                 * Show specific step
                 * @param {number} stepNumber - Step to show
                 */
                show(stepNumber) {
                    state.currentStep = stepNumber;

                    ui.updateProgressBar(stepNumber);

                    // Show/hide steps
                    for (let i = 1; i <= state.totalSteps; i++) {
                        const step = document.getElementById(`step-${i}`);
                        if (step) {
                            if (i === stepNumber) {
                                step.classList.remove('step-hidden', 'step-inactive');

                                // Special handling for step 3
                                if (i === 3) {
                                    this.loadPendingInvitations();
                                }
                            } else {
                                step.classList.add('step-hidden');
                            }
                        }
                    }
                },


                /**
                 * Load pending invitations
                 */
                async loadPendingInvitations() {
                    const elements = {
                        loading: document.getElementById('invitationsLoading'),
                        noInvitations: document.getElementById('noInvitations'),
                        invitations: document.getElementById('pendingInvitations')
                    };

                    ui.setInvitationState(elements, STATES.LOADING);

                    try {
                        // Add minimum loading time for better UX
                        const [invitations] = await Promise.all([
                            api.endpoints.getPendingInvitations(),
                            utils.sleep(1000)
                        ]);

                        if (invitations.length > 0) {
                            elements.invitations.innerHTML = invitations
                                .map(inv => ui.createPendingInvitationHTML(inv))
                                .join('');
                            ui.setInvitationState(elements, STATES.LOADED);
                        } else {
                            ui.setInvitationState(elements, STATES.EMPTY);
                        }

                    } catch (error) {
                        console.error('Error loading invitations:', error);
                        elements.noInvitations.innerHTML = `
                        <p class="text-pastel-textLight">Unable to load invitations</p>
                        <p class="text-sm text-red-500 mt-2">${utils.escapeHtml(error.message)}</p>
                        <button onclick="onboardingApp.loadPendingInvitations()"
                                class="mt-3 text-sm text-pastel-primary hover:underline">
                            Try again
                        </button>
                    `;
                        ui.setInvitationState(elements, STATES.ERROR);
                    }
                }
            };

            // ============================================================================
            // Storage Management
            // ============================================================================

            const storage = {
                /**
                 * Save progress to sessionStorage
                 */
                saveProgress() {
                    sessionStorage.setItem('onboardingProgress', JSON.stringify(state.data));
                },

                /**
                 * Load saved progress
                 */
                loadProgress() {
                    const savedProgress = sessionStorage.getItem('onboardingProgress');
                    if (savedProgress) {
                        try {
                            const progress = JSON.parse(savedProgress);
                            state.data = progress;

                            // Pre-fill forms
                            if (progress.babyInfo) {
                                const fields = {
                                    babyName: progress.babyInfo.name,
                                    babyDob: progress.babyInfo.dob,
                                    babyGender: progress.babyInfo.gender,
                                    babyWeight: progress.babyInfo.weight,
                                    babyHeight: progress.babyInfo.height
                                };

                                Object.entries(fields).forEach(([id, value]) => {
                                    const el = document.getElementById(id);
                                    if (el && value) el.value = value;
                                });
                            }
                        } catch (e) {
                            console.error('Error loading saved progress:', e);
                        }
                    }
                },

                /**
                 * Clear onboarding progress
                 */
                clearProgress() {
                    sessionStorage.removeItem('onboardingProgress');
                }
            };

            // ============================================================================
            // Public API
            // ============================================================================

            return {
                /**
                 * Initialize the application
                 */
                init() {
                    // Check authentication
                    const idToken = sessionStorage.getItem('idToken');
                    const skipOnboarding = sessionStorage.getItem('skipOnboarding');

                    // If user has skip preference, redirect to dashboard
                    if (skipOnboarding === 'true') {
                        window.location.href = '/dashboard';
                        return;
                    }
                    // DEBUG: REMOVE COMMENT
                    // if (!idToken) {
                    //     window.location.href = '/';
                    //     return;
                    // }

                    // Display user information
                    const userInfo = {
                        userName: sessionStorage.getItem('userName'),
                        userEmail: sessionStorage.getItem('userEmail'),
                        userPicture: sessionStorage.getItem('userPicture')
                    };

                    if (userInfo.userName) {
                        document.getElementById('userName').textContent = userInfo.userName;
                    }
                    if (userInfo.userEmail) {
                        document.getElementById('userEmail').textContent = userInfo.userEmail;
                    }
                    if (userInfo.userPicture) {
                        document.getElementById('userPicture').src = userInfo.userPicture;
                    }

                    // Set global auth token
                    window.authToken = idToken;

                    // Instead of showing step 1, initialize the new flow
                    RevisedOnboardingFlow.initializeFlow().catch(error => {
                        console.error('Failed to initialize onboarding:', error);
                        ui.showToast('Error loading setup. Please refresh the page.', MESSAGE_TYPES.ERROR);
                    });

                    // Initialize validators
                    BabyNameValidator.init();

                    // Load saved progress
                    storage.loadProgress();

                    // Update invitations list if we have coParents
                    if (state.data.coParents.length > 0) {
                        ui.updateInvitationsList();
                    }

                    // Add input event listeners for real-time validation
                    this.attachValidationListeners();
                },

                /**
                 * Attach validation listeners to form inputs
                 */
                attachValidationListeners() {
                    // Baby info form
                    ['babyName', 'babyDob', 'babyGender', 'babyWeight', 'babyHeight'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.addEventListener('input', utils.debounce(() => {
                                ui.clearFieldError(id);
                            }, 300));
                        }
                    });

                    // Co-parent email
                    const emailField = document.getElementById('coParentEmail');
                    if (emailField) {
                        emailField.addEventListener('input', utils.debounce(() => {
                            ui.clearFieldError('coParentEmail');
                        }, 300));
                    }

                    // Add form submit prevention
                    const forms = ['babyInfoForm', 'coParentForm'];
                    forms.forEach(formId => {
                        const form = document.getElementById(formId);
                        if (form) {
                            form.addEventListener('submit', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                return false;
                            });
                        }
                    });
                },

                /**
                 * Respond to pending invitation
                 * @param {number} invitationId - Invitation ID
                 * @param {boolean} accept - Accept or decline
                 */
                async respondToInvitation(invitationId, accept) {
                    try {
                        // Disable buttons during request
                        const invCard = document.querySelector(`[data-invitation-id="${invitationId}"]`);
                        if (invCard) {
                            invCard.querySelectorAll('button').forEach(btn => btn.disabled = true);
                        }

                        await api.endpoints.respondToInvitation(invitationId, accept);

                        await api.endpoints.markNotificationAsRead(invitationId);


                        state.data.acceptedInvitations.push(invitationId);
                        storage.saveProgress();

                        const message = accept ? 'Invitation accepted!' : 'Invitation declined';
                        ui.showToast(message, MESSAGE_TYPES.SUCCESS);

                        // Reload invitations
                        await steps.loadPendingInvitations();

                    } catch (error) {
                        ui.showToast(error.message, MESSAGE_TYPES.ERROR);

                        // Re-enable buttons on error
                        const invCard = document.querySelector(`[data-invitation-id="${invitationId}"]`);
                        if (invCard) {
                            invCard.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        }
                    }
                },

                async removeInvitation(notificationId) {
                    try {
                        // Find and disable the remove button
                        const invElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                        if (invElement) {
                            const removeBtn = invElement.querySelector('button');
                            if (removeBtn) {
                                removeBtn.disabled = true;
                                removeBtn.textContent = 'Removing...';
                            }
                        }

                        await api.endpoints.removeNotification(notificationId);

                        // Remove from state
                        state.data.coParents = state.data.coParents.filter(
                            item => (typeof item === 'string' ? false : item.notificationId !== notificationId)
                        );

                        storage.saveProgress();
                        ui.updateInvitationsList();
                        ui.showToast('Invitation removed successfully');

                    } catch (error) {
                        ui.showToast(error.message, MESSAGE_TYPES.ERROR);

                        // Re-enable button on error
                        const invElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                        if (invElement) {
                            const removeBtn = invElement.querySelector('button');
                            if (removeBtn) {
                                removeBtn.disabled = false;
                                removeBtn.textContent = 'Remove';
                            }
                        }
                    }
                },

                /**
                 * Reload pending invitations (exposed for retry button)
                 */
                async loadPendingInvitations() {
                    await steps.loadPendingInvitations();
                },

                /**
                 * Complete onboarding
                 * @param {boolean} showToast - Whether to show completion toast
                 */
                async completeOnboarding(showToast = true) {
                    ui.setButtonLoading('complete-button', true);

                    try {
                        // Clear progress
                        storage.clearProgress();

                        // Mark as complete
                        sessionStorage.setItem('onboardingComplete', 'true');

                        // Show success only if requested
                        if (showToast) {
                            ui.showToast('Welcome to BabyHelper! Redirecting...', MESSAGE_TYPES.SUCCESS);
                        }

                        // Redirect after short delay
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, showToast ? 1500 : 100);

                    } catch (error) {
                        ui.setButtonLoading('complete-button', false);
                        ui.showToast('Error completing setup. Please try again.', MESSAGE_TYPES.ERROR);
                    }
                },

                /**
                 * Logout user
                 */
                logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        sessionStorage.clear();
                        window.location.href = '/';
                    }
                },
                api: api,
                ui: ui,
                storage: storage,
                validation: validation,
                utils: utils,
                MESSAGE_TYPES: MESSAGE_TYPES
            };
        })();

    // Revised Onboarding Flow Controller
    const RevisedOnboardingFlow = {
        // Flow states
        FLOW_STATES: {
            CHECK_INVITATIONS: 'check_invitations',
            CHOOSE_ACTION: 'choose_action',
            ADD_BABY: 'add_baby',
            INVITE_COPARENT: 'invite_coparent',
            REVIEW_COMPLETE: 'review_complete'
        },

        // Data structure for managing multiple babies
        state: {
            currentFlowState: null,
            pendingInvitations: [],
            addedBabies: [],
            currentBabyIndex: null,
            invitedBabyNames: [], // Names from pending invitations
            acceptedInvitations: [],
            skipOnboarding: false
        },

        /**
         * Initialize the revised onboarding flow
         */
        async initializeFlow() {
            // Step 1: Check for pending invitations first
            await this.checkPendingInvitations();

            // Step 2: Determine initial flow state
            if (this.state.pendingInvitations.length > 0) {
                this.setFlowState(this.FLOW_STATES.CHECK_INVITATIONS);
            } else {
                this.setFlowState(this.FLOW_STATES.CHOOSE_ACTION);
            }
        },

        /**
         * Check for pending invitations and extract baby names
         */
        async checkPendingInvitations() {
            try {
                const invitations = await onboardingApp.api.endpoints.getPendingInvitations();
                this.state.pendingInvitations = invitations;

                // Extract baby names from invitations for validation
                this.state.invitedBabyNames = invitations.map(inv =>
                    inv.baby_name.toLowerCase().trim()
                );

                return invitations;
            } catch (error) {
                console.error('Error checking invitations:', error);
                return [];
            }
        },

        /**
         * Set the current flow state and update UI
         */
        setFlowState(newState) {
            this.state.currentFlowState = newState;
            this.updateUIForState(newState);
        },

        /**
         * Update UI based on current flow state
         */
        updateUIForState(flowState) {
            // Hide all sections first
            document.querySelectorAll('.flow-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show relevant section
            switch (flowState) {
                case this.FLOW_STATES.CHECK_INVITATIONS:
                    this.showInvitationsSection();
                    break;
                case this.FLOW_STATES.CHOOSE_ACTION:
                    this.showChooseActionSection();
                    break;
                case this.FLOW_STATES.ADD_BABY:
                    this.showAddBabySection();
                    break;
                case this.FLOW_STATES.INVITE_COPARENT:
                    this.showInviteCoparentSection();
                    break;
                case this.FLOW_STATES.REVIEW_COMPLETE:
                    this.showReviewCompleteSection();
                    break;
            }
        },

        /**
         * Validate baby name against existing invitations
         */
        validateBabyName(babyName) {
            const normalizedName = babyName.toLowerCase().trim();

            // Check if this name exists in pending invitations
            if (this.state.invitedBabyNames.includes(normalizedName)) {
                return {
                    isValid: false,
                    error: `You have a pending invitation for a baby named "${babyName}". Please accept the invitation instead of creating a new entry.`,
                    suggestAction: 'view_invitations'
                };
            }

            // Check if already added in this session
            const alreadyAdded = this.state.addedBabies.some(baby =>
                baby.name.toLowerCase() === normalizedName
            );

            if (alreadyAdded) {
                return {
                    isValid: false,
                    error: `You've already added "${babyName}" in this session.`
                };
            }

            return {isValid: true};
        },

        /**
         * Add a new baby with validation
         */
        async addBaby(babyData) {
            // Validate name first
            const nameValidation = this.validateBabyName(babyData.name);
            if (!nameValidation.isValid) {
                throw new Error(nameValidation.error);
            }

            // Save baby to backend
            const savedBaby = await onboardingApp.api.endpoints.createBaby({
                fullname: babyData.name,
                birthdate: babyData.birthdate,
                sex: babyData.gender,
                weight: babyData.weight,
                height: babyData.height
            });

            // Add to local state
            this.state.addedBabies.push({
                id: savedBaby.id,
                name: savedBaby.fullname,
                coparents: []
            });

            this.state.currentBabyIndex = this.state.addedBabies.length - 1;

            return savedBaby;
        },

        /**
         * Show action menu after invitations or initial setup
         */
        showChooseActionSection() {
            const content = `
            <div class="text-center space-y-6">
                <h2 class="font-serif text-3xl text-pastel-heading">
                    What would you like to do?
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    <!-- Add New Baby Option -->
                    <button onclick="RevisedOnboardingFlow.startAddBaby()"
                            class="p-6 bg-white rounded-xl border-2 border-pastel-light hover:border-pastel-primary transition-all group">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-pastel-lightest group-hover:bg-pastel-secondary transition-colors flex items-center justify-center">
                            <svg class="w-8 h-8 text-pastel-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                        </div>
                        <h3 class="font-semibold text-lg text-pastel-heading mb-2">Add a Baby</h3>
                        <p class="text-sm text-pastel-textLight">Register a new baby to your account</p>
                    </button>

                    <!-- View Invitations Option (if any exist) -->
                    ${this.state.pendingInvitations.length > 0 ? `
                        <button onclick="RevisedOnboardingFlow.viewInvitations()"
                                class="p-6 bg-white rounded-xl border-2 border-pastel-light hover:border-pastel-accent1 transition-all group relative">
                            <span class="absolute top-4 right-4 bg-pastel-primary text-white text-xs px-2 py-1 rounded-full">
                                ${this.state.pendingInvitations.length}
                            </span>
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-pastel-lightest group-hover:bg-pastel-accent1 group-hover:bg-opacity-20 transition-colors flex items-center justify-center">
                                <svg class="w-8 h-8 text-pastel-accent1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-lg text-pastel-heading mb-2">View Invitations</h3>
                            <p class="text-sm text-pastel-textLight">You have pending co-parent invitations</p>
                        </button>
                    ` : ''}
                </div>

                <!-- Summary of current progress -->
                ${this.state.addedBabies.length > 0 ? `
                    <div class="mt-8 p-4 bg-pastel-lightest rounded-lg">
                        <h4 class="font-medium text-pastel-heading mb-2">Babies Added:</h4>
                        <div class="space-y-2">
                            ${this.state.addedBabies.map(baby => `
                                <div class="flex items-center justify-between text-sm">
                                    <span>${baby.name}</span>
                                    <span class="text-pastel-textLight">
                                        ${baby.coparents.length} co-parent${baby.coparents.length !== 1 ? 's' : ''} invited
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Complete or Skip Setup -->
                <div class="mt-8">
                    ${(this.state.addedBabies.length > 0 || this.state.acceptedInvitations.length > 0) ? `
                        <button onclick="RevisedOnboardingFlow.completeSetup()"
                                class="px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                            Complete Setup
                        </button>
                    ` : `
                        <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button onclick="CompletionFlow.goToDashboard()"
                                    class="w-full sm:w-auto px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                                Go to Dashboard
                            </button>

                            <div class="flex items-center space-x-3">
                                <input type="checkbox"
                                       id="skip-onboarding-checkbox"
                                       class="w-4 h-4 text-pastel-primary rounded focus:ring-pastel-primary">
                                <label for="skip-onboarding-checkbox" class="text-sm text-pastel-text">
                                    Don't show this setup again
                                </label>
                            </div>
                        </div>
                    `}
                </div>

            </div>
        `;

            document.getElementById('dynamic-content').innerHTML = content;
        },

        /**
         * Show invitations section
         */
        showInvitationsSection() {
            // Update progress indicator
            this.updateProgressIndicator('invitations');

            // Use the ConditionalInvitations component to display invitations
            ConditionalInvitations.displayInvitations();
        },

        /**
         * Show add baby section
         */
        showAddBabySection() {
            // Update progress indicator
            this.updateProgressIndicator('add_baby');

            const content = `
        <div class="max-w-2xl mx-auto flow-section">
            <!-- Header -->
            <div class="text-center mb-8">
                <h2 class="font-serif text-3xl text-pastel-heading mb-2">
                    Add Your Baby's Information
                </h2>
                <p class="text-pastel-textLight">
                    Let's get to know your little one
                </p>
            </div>

            <!-- Baby Info Form -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-pastel-light">
                <form id="babyInfoForm" onsubmit="event.preventDefault(); return false;">
                    <!-- Name field with real-time validation -->
                    <div class="mb-6">
                        <label for="babyName" class="block text-sm font-medium text-pastel-text mb-2">
                            Baby's Name
                        </label>
                        <input type="text"
                               id="babyName"
                               name="babyName"
                               placeholder="Enter baby's name"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary"
                               required>
                        <div id="name-validation-feedback"></div>
                        <span id="babyName-error" class="hidden text-xs text-red-500 mt-1"></span>
                    </div>

                    <!-- Date of Birth -->
                    <div class="mb-6">
                        <label for="babyDob" class="block text-sm font-medium text-pastel-text mb-2">
                            Date of Birth
                        </label>
                        <input type="date"
                               id="babyDob"
                               name="babyDob"
                               max="${new Date().toISOString().split('T')[0]}"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary"
                               required>
                        <span id="babyDob-error" class="hidden text-xs text-red-500 mt-1"></span>
                    </div>

                    <!-- Gender -->
                    <div class="mb-6">
                        <label for="babyGender" class="block text-sm font-medium text-pastel-text mb-2">
                            Gender
                        </label>
                        <select id="babyGender"
                                name="babyGender"
                                class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary"
                                required>
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                        <span id="babyGender-error" class="hidden text-xs text-red-500 mt-1"></span>
                    </div>

                    <!-- Birth Measurements -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="babyWeight" class="block text-sm font-medium text-pastel-text mb-2">
                                Birth Weight (kg)
                            </label>
                            <input type="number"
                                   id="babyWeight"
                                   name="babyWeight"
                                   step="0.01"
                                   min="0.5"
                                   max="10"
                                   placeholder="3.5"
                                   class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary"
                                   required>
                            <span id="babyWeight-error" class="hidden text-xs text-red-500 mt-1"></span>
                        </div>
                        <div>
                            <label for="babyHeight" class="block text-sm font-medium text-pastel-text mb-2">
                                Birth Height (cm)
                            </label>
                            <input type="number"
                                   id="babyHeight"
                                   name="babyHeight"
                                   step="0.1"
                                   min="30"
                                   max="70"
                                   placeholder="50"
                                   class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary"
                                   required>
                            <span id="babyHeight-error" class="hidden text-xs text-red-500 mt-1"></span>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-between items-center">
                        <button type="button"
                                onclick="RevisedOnboardingFlow.showChooseActionSection()"
                                class="text-pastel-textLight hover:text-pastel-text transition-colors">
                             Back
                        </button>
                        <button type="button"
                                id="save-baby-button"
                                onclick="RevisedOnboardingFlow.saveBabyAndContinue()"
                                class="px-6 py-2 bg-pastel-primary text-white font-medium rounded-lg hover:bg-pastel-primaryHover transition-colors flex items-center space-x-2">
                            <span>Save & Continue</span>
                            <div class="spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

            document.getElementById('dynamic-content').innerHTML = content;

            // Re-initialize the validator for the new form
            BabyNameValidator.init();

            // Re-attach validation listeners
            onboardingApp.attachValidationListeners();
        },

        /**
         * Show invite co-parent section
         */
        showInviteCoparentSection() {
            // Update progress indicator
            this.updateProgressIndicator('invite_coparent');

            const currentBaby = this.state.addedBabies[this.state.currentBabyIndex];

            if (!currentBaby) {
                // No baby selected, go back to action menu
                this.showChooseActionSection();
                return;
            }

            const content = `
        <div class="max-w-2xl mx-auto flow-section">
            <!-- Header -->
            <div class="text-center mb-8">
                <h2 class="font-serif text-3xl text-pastel-heading mb-2">
                    Invite Co-parents for ${onboardingApp.utils.escapeHtml(currentBaby.name)}
                </h2>
                <p class="text-pastel-textLight">
                    Share baby care responsibilities with your partner or family
                </p>
            </div>

            <!-- Invite Form -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-pastel-light">
                <form id="coParentForm" onsubmit="event.preventDefault(); return false;">
                    <!-- Email Input -->
                    <div class="mb-6">
                        <label for="coParentEmail" class="block text-sm font-medium text-pastel-text mb-2">
                            Co-parent's Email Address
                        </label>
                        <input type="email"
                               id="coParentEmail"
                               name="coParentEmail"
                               placeholder="partner@gmail.com"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                        <span id="coParentEmail-error" class="hidden text-xs text-red-500 mt-1"></span>
                        <p class="text-xs text-pastel-textLight mt-2">
                            They'll receive an email invitation to join as a co-parent
                        </p>
                    </div>

                    <!-- Send Button -->
                    <div class="flex justify-center">
                        <button type="button"
                                id="invite-submit"
                                onclick="RevisedOnboardingFlow.sendCoparentInviteForCurrentBaby()"
                                class="px-6 py-2 bg-pastel-primary text-white font-medium rounded-lg hover:bg-pastel-primaryHover transition-colors flex items-center space-x-2">
                            <span>Send Invitation</span>
                            <div class="spinner hidden"></div>
                        </button>
                    </div>
                </form>

                <!-- Invited List -->
                <div id="invitedList" class="${currentBaby.coparents.length === 0 ? 'hidden' : ''} mt-8">
                    <h3 class="font-medium text-pastel-heading mb-3">Sent Invitations</h3>
                    <div id="invitationsList" class="space-y-2">
                        ${currentBaby.coparents.map((coparent, index) => `
                            <div class="p-3 bg-pastel-lightest rounded-lg flex justify-between items-center">
                                <span class="text-sm text-pastel-text">${onboardingApp.utils.escapeHtml(coparent.email)}</span>
                                ${coparent.notificationId ? `
                                    <button onclick="RevisedOnboardingFlow.removeCoparentInvite(${this.state.currentBabyIndex}, ${index})"
                                            class="text-xs text-red-500 hover:text-red-700 font-medium transition-colors">
                                        Remove
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Info Box -->
                <div class="mt-8 p-4 bg-pastel-lightest rounded-lg">
                    <div class="flex items-start space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pastel-primary mt-0.5 flex-shrink-0"
                             fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-pastel-textLight">
                            <p>You can invite multiple co-parents now or add more later from your dashboard.</p>
                            <p class="mt-1">Co-parents will be able to track and log baby activities.</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="RevisedOnboardingFlow.showChooseActionSection()"
                            class="text-pastel-textLight hover:text-pastel-text transition-colors">
                         Back to Menu
                    </button>
                    <button onclick="RevisedOnboardingFlow.skipInvitesAndContinue()"
                            class="px-6 py-2 border border-pastel-light text-pastel-text font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                        Continue
                    </button>
                </div>
            </div>
        </div>
    `;

            document.getElementById('dynamic-content').innerHTML = content;

            // Re-attach validation listeners
            onboardingApp.attachValidationListeners();
        },

        /**
         * Start add baby flow from action menu
         */
        startAddBaby() {
            this.setFlowState(this.FLOW_STATES.ADD_BABY);
        },

        /**
         * View invitations from action menu
         */
        viewInvitations() {
            this.setFlowState(this.FLOW_STATES.CHECK_INVITATIONS);
        },

        /**
         * Complete setup and go to review
         */
        completeSetup() {
            // If user has added babies or accepted invitations, show review
            if (this.state.addedBabies.length > 0 || this.state.acceptedInvitations.length > 0) {
                this.setFlowState(this.FLOW_STATES.REVIEW_COMPLETE);
            } else {
                // No setup done, just complete onboarding
                onboardingApp.completeOnboarding(false);
            }
        },

        /**
         * Show review and complete section
         */
        showReviewCompleteSection() {
            // Update progress indicator
            this.updateProgressIndicator('complete');

            // Use the CompletionFlow component
            CompletionFlow.showReviewCompleteSection();
        },

        /**
         * Update progress indicator based on flow state
         */
        updateProgressIndicator(currentSection) {
            const progressContainer = document.getElementById('progress-indicator');
            if (!progressContainer) return;

            // Define progress steps based on what the user is doing
            let steps = [];

            if (this.state.pendingInvitations.length > 0) {
                steps.push({id: 'invitations', label: 'Review Invitations', icon: ''});
            }

            if (this.state.addedBabies.length > 0 || currentSection === 'add_baby') {
                steps.push({id: 'add_baby', label: 'Add Baby', icon: ''});
            }

            if (this.state.addedBabies.some(b => b.coparents.length > 0) || currentSection === 'invite_coparent') {
                steps.push({id: 'invite_coparent', label: 'Invite Co-parents', icon: ''});
            }

            steps.push({id: 'complete', label: 'Complete', icon: ''});

            // Generate progress HTML
            progressContainer.innerHTML = `
        <div class="flex items-center justify-center">
            <div class="flex items-center space-x-4">
                ${steps.map((step, index) => `
                    <div class="flex items-center">
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full ${currentSection === step.id ? 'bg-pastel-primary text-white' : 'bg-pastel-light text-pastel-textLight'}
                                        flex items-center justify-center font-medium transition-all">
                                <span class="text-lg">${step.icon}</span>
                            </div>
                            <span class="text-xs mt-2 ${currentSection === step.id ? 'text-pastel-primary font-medium' : 'text-pastel-textLight'}">
                                ${step.label}
                            </span>
                        </div>
                        ${index < steps.length - 1 ? `
                            <div class="w-16 h-0.5 ${index < steps.findIndex(s => s.id === currentSection) ? 'bg-pastel-primary' : 'bg-pastel-light'}
                                        mx-2 mt-[-20px]"></div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;

            progressContainer.classList.remove('hidden');
        },

        /**
         * Save baby and continue to next step
         */
        async saveBabyAndContinue() {
            try {
                // Validate the form first
                const validationResult = onboardingApp.validation.validateBabyInfo();
                if (!validationResult.isValid) {
                    throw new Error('Please correct the errors before continuing');
                }

                // Check baby name validation state
                if (BabyNameValidator.currentState === BabyNameValidator.VALIDATION_STATES.INVALID) {
                    throw new Error('Please resolve the baby name conflict before continuing');
                }

                // Prepare baby data
                const babyData = {
                    name: document.getElementById('babyName').value.trim(),
                    birthdate: onboardingApp.utils.formatDateForAPI(document.getElementById('babyDob').value),
                    gender: document.getElementById('babyGender').value,
                    weight: parseFloat(document.getElementById('babyWeight').value),
                    height: parseFloat(document.getElementById('babyHeight').value)
                };

                // Show loading state
                onboardingApp.ui.setButtonLoading('save-baby-button', true);

                // Add the baby
                await this.addBaby(babyData);

                // Save progress
                onboardingApp.storage.saveProgress();

                // Show success
                onboardingApp.ui.showToast('Baby information saved successfully!', onboardingApp.MESSAGE_TYPES.SUCCESS);

                // Move to invite co-parent step
                this.setFlowState(this.FLOW_STATES.INVITE_COPARENT);

            } catch (error) {
                onboardingApp.ui.showToast(error.message, onboardingApp.MESSAGE_TYPES.ERROR);
                onboardingApp.ui.setButtonLoading('save-baby-button', false);
            }
        },

        /**
         * Send co-parent invite for current baby
         */
        async sendCoparentInviteForCurrentBaby() {
            const currentBaby = this.state.addedBabies[this.state.currentBabyIndex];

            if (!currentBaby) {
                onboardingApp.ui.showToast('No baby selected', onboardingApp.MESSAGE_TYPES.ERROR);
                return;
            }

            const validationResult = onboardingApp.validation.validateCoparentEmail();
            if (!validationResult.isValid) {
                onboardingApp.ui.showToast(validationResult.error, onboardingApp.MESSAGE_TYPES.ERROR);
                return;
            }

            const email = document.getElementById('coParentEmail').value.trim();

            // Check if already invited for this baby
            if (currentBaby.coparents.some(cp => cp.email === email)) {
                onboardingApp.ui.showFieldError('coParentEmail', 'Already invited for this baby');
                return;
            }

            onboardingApp.ui.setButtonLoading('invite-submit', true);

            try {
                const result = await onboardingApp.api.endpoints.sendCoparentInvite({
                    baby_id: currentBaby.id,
                    email: email
                });

                // Extract notification ID
                const match = result.message.match(/notification: (\d+)$/);
                const notificationId = match ? parseInt(match[1]) : null;

                // Add to current baby's coparents
                currentBaby.coparents.push({
                    email: email,
                    notificationId: notificationId,
                    status: 'pending'
                });

                // Save progress
                onboardingApp.storage.saveProgress();

                // Clear input
                document.getElementById('coParentEmail').value = '';

                // Update UI
                this.showInviteCoparentSection();

                onboardingApp.ui.showToast('Invitation sent successfully!', onboardingApp.MESSAGE_TYPES.SUCCESS);

            } catch (error) {
                onboardingApp.ui.showToast(error.message, onboardingApp.MESSAGE_TYPES.ERROR);
            } finally {
                onboardingApp.ui.setButtonLoading('invite-submit', false);
            }
        },

        /**
         * Remove co-parent invite
         */
        async removeCoparentInvite(babyIndex, coparentIndex) {
            const baby = this.state.addedBabies[babyIndex];
            const coparent = baby.coparents[coparentIndex];

            if (!confirm(`Remove invitation to ${coparent.email}?`)) {
                return;
            }

            try {
                if (coparent.notificationId) {
                    await onboardingApp.api.endpoints.removeNotification(coparent.notificationId);
                }

                // Remove from local state
                baby.coparents.splice(coparentIndex, 1);

                // Save progress
                onboardingApp.storage.saveProgress();

                // Refresh UI
                this.showInviteCoparentSection();

                onboardingApp.ui.showToast('Invitation removed', onboardingApp.MESSAGE_TYPES.SUCCESS);

            } catch (error) {
                onboardingApp.ui.showToast('Failed to remove invitation: ' + error.message, onboardingApp.MESSAGE_TYPES.ERROR);
            }
        },

        /**
         * Skip invites and continue
         */
        skipInvitesAndContinue() {
            this.showChooseActionSection();
        }
    };

    // Baby Name Validator Component with Real-time Checking
    const BabyNameValidator = {
        // Validation states
        VALIDATION_STATES: {
            IDLE: 'idle',
            CHECKING: 'checking',
            VALID: 'valid',
            INVALID: 'invalid',
            WARNING: 'warning'
        },

        currentState: null,
        validationTimeout: null,

        /**
         * Initialize the validator with real-time checking
         */
        init() {
            const nameInput = document.getElementById('babyName');
            if (!nameInput) return;

            // Add real-time validation
            nameInput.addEventListener('input', (e) => {
                this.validateNameRealtime(e.target.value);
            });

            // Add blur validation for final check
            nameInput.addEventListener('blur', (e) => {
                this.validateNameComplete(e.target.value);
            });
        },

        /**
         * Real-time validation with debouncing
         */
        validateNameRealtime(name) {
            // Clear previous timeout
            if (this.validationTimeout) {
                clearTimeout(this.validationTimeout);
            }

            // Reset state if empty
            if (!name.trim()) {
                this.updateValidationUI(this.VALIDATION_STATES.IDLE);
                return;
            }

            // Show checking state
            this.updateValidationUI(this.VALIDATION_STATES.CHECKING);

            // Debounce the validation
            this.validationTimeout = setTimeout(() => {
                this.performValidation(name);
            }, 500);
        },

        /**
         * Complete validation on blur
         */
        validateNameComplete(name) {
            if (!name.trim()) {
                this.updateValidationUI(this.VALIDATION_STATES.INVALID, 'Baby name is required');
                return;
            }

            this.performValidation(name);
        },

        /**
         * Perform the actual validation
         */
        performValidation(name) {
            const normalizedName = name.toLowerCase().trim();

            // Check basic validation rules
            if (name.length > 100) {
                this.updateValidationUI(this.VALIDATION_STATES.INVALID, 'Name must be less than 100 characters');
                return;
            }

            if (!/^[a-zA-Z\s'-]+$/.test(name)) {
                this.updateValidationUI(this.VALIDATION_STATES.INVALID, 'Name can only contain letters, spaces, hyphens, and apostrophes');
                return;
            }

            // Check against pending invitations
            const invitedBaby = RevisedOnboardingFlow.state.pendingInvitations.find(inv =>
                inv.baby_name.toLowerCase() === normalizedName
            );

            if (invitedBaby) {
                this.showInvitationConflict(invitedBaby);
                return;
            }

            // Check for similar names (fuzzy matching)
            const similarInvitation = this.findSimilarInvitation(normalizedName);
            if (similarInvitation) {
                this.showSimilarNameWarning(similarInvitation);
                return;
            }

            // Check if already added in this session
            const alreadyAdded = RevisedOnboardingFlow.state.addedBabies.some(baby =>
                baby.name.toLowerCase() === normalizedName
            );

            if (alreadyAdded) {
                this.updateValidationUI(this.VALIDATION_STATES.INVALID, 'You\'ve already added this baby');
                return;
            }

            // All checks passed
            this.updateValidationUI(this.VALIDATION_STATES.VALID, 'Name is available');
        },

        /**
         * Find similar baby names in invitations (fuzzy matching)
         */
        findSimilarInvitation(name) {
            const threshold = 0.8; // 80% similarity threshold

            for (const invitation of RevisedOnboardingFlow.state.pendingInvitations) {
                const similarity = this.calculateSimilarity(name, invitation.baby_name.toLowerCase());
                if (similarity >= threshold) {
                    return invitation;
                }
            }

            return null;
        },

        /**
         * Calculate string similarity (Levenshtein distance based)
         */
        calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 1.0;

            const editDistance = this.levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        },

        /**
         * Calculate Levenshtein distance between two strings
         */
        levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        },

        /**
         * Show invitation conflict UI
         */
        showInvitationConflict(invitation) {
            const validationContainer = document.getElementById('name-validation-feedback');
            if (!validationContainer) return;

            validationContainer.innerHTML = `
            <div class="mt-2 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-yellow-800">
                            You have a pending invitation for this baby
                        </p>
                        <p class="text-sm text-yellow-700 mt-1">
                            ${invitation.inviter_name} has invited you to be a co-parent for ${invitation.baby_name}.
                        </p>
                        <button onclick="BabyNameValidator.switchToInvitations(${invitation.invitation_id})"
                                class="mt-2 text-sm font-medium text-yellow-800 hover:text-yellow-900 underline">
                            View invitation 
                        </button>
                    </div>
                </div>
            </div>
        `;

            this.currentState = this.VALIDATION_STATES.INVALID;
            this.updateNameInputUI(false);
        },

        /**
         * Show similar name warning
         */
        showSimilarNameWarning(invitation) {
            const validationContainer = document.getElementById('name-validation-feedback');
            if (!validationContainer) return;

            validationContainer.innerHTML = `
            <div class="mt-2 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-blue-800">
                            Similar name found in invitations
                        </p>
                        <p class="text-sm text-blue-700 mt-1">
                            Did you mean "${invitation.baby_name}" from ${invitation.inviter_name}?
                        </p>
                        <div class="mt-2 space-x-3">
                            <button onclick="BabyNameValidator.switchToInvitations(${invitation.invitation_id})"
                                    class="text-sm font-medium text-blue-800 hover:text-blue-900 underline">
                                Yes, view invitation
                            </button>
                            <button onclick="BabyNameValidator.dismissWarning()"
                                    class="text-sm font-medium text-gray-600 hover:text-gray-700">
                                No, continue with this name
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            this.currentState = this.VALIDATION_STATES.WARNING;
            this.updateNameInputUI(true); // Allow continuation with warning
        },

        /**
         * Update validation UI based on state
         */
        updateValidationUI(state, message = '') {
            const validationContainer = document.getElementById('name-validation-feedback');
            const nameInput = document.getElementById('babyName');

            if (!validationContainer || !nameInput) return;

            this.currentState = state;

            // Clear previous validation
            validationContainer.innerHTML = '';

            switch (state) {
                case this.VALIDATION_STATES.CHECKING:
                    validationContainer.innerHTML = `
                    <div class="mt-1 flex items-center space-x-2 text-sm text-pastel-textLight">
                        <div class="spinner w-4 h-4"></div>
                        <span>Checking name availability...</span>
                    </div>
                `;
                    break;

                case this.VALIDATION_STATES.VALID:
                    validationContainer.innerHTML = `
                    <div class="mt-1 flex items-center space-x-2 text-sm text-green-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;
                    this.updateNameInputUI(true);
                    break;

                case this.VALIDATION_STATES.INVALID:
                    validationContainer.innerHTML = `
                    <div class="mt-1 flex items-center space-x-2 text-sm text-red-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;
                    this.updateNameInputUI(false);
                    break;

                case this.VALIDATION_STATES.IDLE:
                    this.updateNameInputUI(true);
                    break;
            }
        },

        /**
         * Update name input field UI based on validation state
         */
        updateNameInputUI(isValid) {
            const nameInput = document.getElementById('babyName');
            if (!nameInput) return;

            if (isValid) {
                nameInput.classList.remove('border-red-500', 'border-yellow-500');
                nameInput.classList.add('border-pastel-light');
            } else {
                nameInput.classList.remove('border-pastel-light');
                nameInput.classList.add('border-red-500');
            }
        },

        /**
         * Switch to invitations view
         */
        switchToInvitations(invitationId) {
            RevisedOnboardingFlow.setFlowState(RevisedOnboardingFlow.FLOW_STATES.CHECK_INVITATIONS);
            // Optionally highlight the specific invitation
            setTimeout(() => {
                const invitationElement = document.querySelector(`[data-invitation-id="${invitationId}"]`);
                if (invitationElement) {
                    invitationElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                    invitationElement.classList.add('ring-2', 'ring-pastel-primary', 'ring-opacity-50');
                }
            }, 300);
        },

        /**
         * Dismiss warning and continue
         */
        dismissWarning() {
            this.updateValidationUI(this.VALIDATION_STATES.VALID, 'You can use this name');
        }
    };

    // Multi-Baby Manager Component
    const MultiBabyManager = {
        // Current baby being edited
        currentBaby: null,

        /**
         * Show baby management interface
         */
        showBabyManagementUI() {
            const container = document.getElementById('dynamic-content');

            container.innerHTML = `
            <div class="max-w-5xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h2 class="font-serif text-3xl text-pastel-heading mb-2">
                        Manage Your Babies
                    </h2>
                    <p class="text-pastel-textLight">
                        Add babies to your account and invite co-parents for each one
                    </p>
                </div>

                <!-- Baby Cards Grid -->
                <div id="baby-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    ${this.renderBabyCards()}
                    ${this.renderAddBabyCard()}
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center space-x-4 mt-8">
                    <button onclick="RevisedOnboardingFlow.showChooseActionSection()"
                            class="px-6 py-3 border border-pastel-light text-pastel-text font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                        Back to Menu
                    </button>
                    <button onclick="RevisedOnboardingFlow.completeSetup()"
                            class="px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                        Complete Setup
                    </button>
                </div>
            </div>
        `;
        },

        /**
         * Render baby cards
         */
        renderBabyCards() {
            return RevisedOnboardingFlow.state.addedBabies.map((baby, index) => `
            <div class="bg-white rounded-xl shadow-lg p-6 border border-pastel-light relative group"
                 data-baby-index="${index}">
                <!-- Edit Button -->
                <button onclick="MultiBabyManager.editBaby(${index})"
                        class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg class="w-5 h-5 text-pastel-textLight hover:text-pastel-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </button>

                <!-- Baby Avatar -->
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-pastel-secondary to-pastel-accent1 flex items-center justify-center">
                    <span class="text-2xl font-serif font-semibold text-white">
                        ${baby.name.charAt(0).toUpperCase()}
                    </span>
                </div>

                <!-- Baby Info -->
                <h3 class="font-serif text-xl text-pastel-heading text-center mb-4">
                    ${baby.name}
                </h3>

                <!-- Co-parents Section -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-pastel-text">Co-parents</span>
                        <button onclick="MultiBabyManager.showAddCoparentModal(${index})"
                                class="text-xs text-pastel-primary hover:text-pastel-primaryHover font-medium">
                            + Add
                        </button>
                    </div>

                    ${baby.coparents.length > 0 ? `
                        <div class="space-y-1">
                            ${baby.coparents.map((coparent, cpIndex) => `
                                <div class="flex items-center justify-between p-2 bg-pastel-lightest rounded-lg text-sm">
                                    <span class="text-pastel-text truncate">${coparent.email}</span>
                                    <button onclick="MultiBabyManager.removeCoparent(${index}, ${cpIndex})"
                                            class="text-red-500 hover:text-red-700 ml-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <p class="text-sm text-pastel-textLight text-center py-2">
                            No co-parents added yet
                        </p>
                    `}
                </div>

                <!-- Quick Stats -->
                <div class="mt-4 pt-4 border-t border-pastel-light grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <span class="text-pastel-textLight">Added:</span>
                        <span class="text-pastel-text ml-1">${new Date().toLocaleDateString()}</span>
                    </div>
                    <div>
                        <span class="text-pastel-textLight">Status:</span>
                        <span class="text-green-600 ml-1">Active</span>
                    </div>
                </div>
            </div>
        `).join('');
        },

        /**
         * Render add baby card
         */
        renderAddBabyCard() {
            return `
            <button onclick="MultiBabyManager.showAddBabyForm()"
                    class="bg-white rounded-xl shadow-lg p-6 border-2 border-dashed border-pastel-light hover:border-pastel-primary transition-all group">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-pastel-lightest group-hover:bg-pastel-secondary transition-colors flex items-center justify-center">
                    <svg class="w-10 h-10 text-pastel-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </div>
                <h3 class="font-serif text-xl text-pastel-heading text-center mb-2">
                    Add Another Baby
                </h3>
                <p class="text-sm text-pastel-textLight text-center">
                    Click to register a new baby
                </p>
            </button>
        `;
        },

        /**
         * Show add co-parent modal
         */
        showAddCoparentModal(babyIndex) {
            const baby = RevisedOnboardingFlow.state.addedBabies[babyIndex];

            const modal = document.createElement('div');
            modal.id = 'coparent-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
                 onclick="MultiBabyManager.closeCoparentModal()"></div>

            <!-- Modal Content -->
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full transform transition-all relative">
                <div class="p-6">
                    <h3 class="font-serif text-2xl text-pastel-heading mb-2">
                        Add Co-parent for ${baby.name}
                    </h3>
                    <p class="text-sm text-pastel-textLight mb-6">
                        Invite someone to share baby care responsibilities
                    </p>

                    <form onsubmit="event.preventDefault(); MultiBabyManager.addCoparent(${babyIndex});">
                        <div class="mb-4">
                            <label for="modal-coparent-email" class="block text-sm font-medium text-pastel-text mb-2">
                                Co-parent's Email
                            </label>
                            <input type="email"
                                   id="modal-coparent-email"
                                   placeholder="partner@gmail.com"
                                   class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary"
                                   required>
                            <div id="modal-email-error" class="hidden mt-1 text-xs text-red-500"></div>
                        </div>

                        <!-- Existing co-parents list -->
                        ${baby.coparents.length > 0 ? `
                            <div class="mb-4 p-3 bg-pastel-lightest rounded-lg">
                                <p class="text-xs text-pastel-textLight mb-2">Already invited:</p>
                                <div class="space-y-1">
                                    ${baby.coparents.map(cp => `
                                        <div class="text-sm text-pastel-text">${cp.email}</div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex justify-end space-x-3">
                            <button type="button"
                                    onclick="MultiBabyManager.closeCoparentModal()"
                                    class="px-6 py-2 text-pastel-text hover:text-pastel-heading transition-colors">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="px-6 py-2 bg-pastel-primary text-white font-medium rounded-lg hover:bg-pastel-primaryHover transition-colors">
                                Send Invitation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

            document.body.appendChild(modal);

            // Focus email input
            setTimeout(() => {
                document.getElementById('modal-coparent-email').focus();
            }, 100);
        },

        /**
         * Add co-parent to specific baby
         */
        async addCoparent(babyIndex) {
            const baby = RevisedOnboardingFlow.state.addedBabies[babyIndex];
            const emailInput = document.getElementById('modal-coparent-email');
            const email = emailInput.value.trim();
            const errorDiv = document.getElementById('modal-email-error');

            // Reset error
            errorDiv.classList.add('hidden');

            // Validate email
            if (!onboardingApp.utils.isValidGmail(email)) {
                errorDiv.textContent = 'Please enter a valid Gmail address';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Check if already added
            if (baby.coparents.some(cp => cp.email === email)) {
                errorDiv.textContent = 'This person is already a co-parent for this baby';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Check if it's the user's email
            const userEmail = sessionStorage.getItem('userEmail');
            if (email === userEmail) {
                errorDiv.textContent = 'You cannot invite yourself as a co-parent';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                // Send invitation
                const result = await onboardingApp.api.endpoints.sendCoparentInvite({
                    baby_id: baby.id,
                    email: email
                });

                // Extract notification ID
                const match = result.message.match(/notification: (\d+)$/);
                const notificationId = match ? parseInt(match[1]) : null;

                // Add to baby's coparents
                baby.coparents.push({
                    email: email,
                    notificationId: notificationId,
                    status: 'pending'
                });

                // Save progress
                onboardingApp.storage.saveProgress();

                // Close modal and refresh UI
                this.closeCoparentModal();
                this.showBabyManagementUI();

                onboardingApp.ui.showToast(`Invitation sent to ${email}`, onboardingApp.MESSAGE_TYPES.SUCCESS);

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        },

        /**
         * Remove co-parent from specific baby
         */
        async removeCoparent(babyIndex, coparentIndex) {
            const baby = RevisedOnboardingFlow.state.addedBabies[babyIndex];
            const coparent = baby.coparents[coparentIndex];

            if (!confirm(`Remove ${coparent.email} as a co-parent for ${baby.name}?`)) {
                return;
            }

            try {
                // If there's a notification ID, remove it
                if (coparent.notificationId) {
                    await onboardingApp.api.endpoints.removeNotification(coparent.notificationId);
                }

                // Remove from local state
                baby.coparents.splice(coparentIndex, 1);

                // Save progress
                onboardingApp.storage.saveProgress();

                // Refresh UI
                this.showBabyManagementUI();

                onboardingApp.ui.showToast('Co-parent removed successfully', onboardingApp.MESSAGE_TYPES.SUCCESS);

            } catch (error) {
                onboardingApp.ui.showToast('Failed to remove co-parent: ' + error.message, onboardingApp.MESSAGE_TYPES.ERROR);
            }
        },

        /**
         * Close co-parent modal
         */
        closeCoparentModal() {
            const modal = document.getElementById('coparent-modal');
            if (modal) {
                modal.remove();
            }
        },

        /**
         * Show add baby form in a slide-over panel
         */
        showAddBabyForm() {
            RevisedOnboardingFlow.setFlowState(RevisedOnboardingFlow.FLOW_STATES.ADD_BABY);
        },

        /**
         * Edit existing baby
         */
        editBaby(babyIndex) {
            const baby = RevisedOnboardingFlow.state.addedBabies[babyIndex];
            this.currentBaby = baby;

            // Show edit form with pre-filled data
            RevisedOnboardingFlow.setFlowState(RevisedOnboardingFlow.FLOW_STATES.ADD_BABY);

            // Pre-fill form after a short delay
            setTimeout(() => {
                document.getElementById('babyName').value = baby.name;
                // Pre-fill other fields if stored
            }, 100);
        }
    };

    // Conditional Invitation Display Component
    const ConditionalInvitations = {
        // Track which invitations have been interacted with
        processedInvitations: new Set(),

        /**
         * Display invitations with smart grouping
         */
        displayInvitations() {
            const container = document.getElementById('dynamic-content');
            const invitations = RevisedOnboardingFlow.state.pendingInvitations;

            // Group invitations by inviter
            const groupedInvitations = this.groupInvitationsByInviter(invitations);

            container.innerHTML = `
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h2 class="font-serif text-3xl text-pastel-heading mb-2">
                        You Have ${invitations.length} Pending Invitation${invitations.length !== 1 ? 's' : ''}
                    </h2>
                    <p class="text-pastel-textLight">
                        Accept invitations to become a co-parent and share baby care responsibilities
                    </p>
                </div>

                <!-- Quick Actions Bar -->
                <div class="mb-6 p-4 bg-pastel-lightest rounded-lg flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="ConditionalInvitations.acceptAllInvitations()"
                                class="text-sm font-medium text-pastel-primary hover:text-pastel-primaryHover">
                            Accept All
                        </button>
                        <button onclick="ConditionalInvitations.declineAllInvitations()"
                                class="text-sm font-medium text-pastel-textLight hover:text-pastel-text">
                            Decline All
                        </button>
                    </div>
                    <button onclick="RevisedOnboardingFlow.showChooseActionSection()"
                            class="text-sm text-pastel-textLight hover:text-pastel-text">
                        Skip for now 
                    </button>
                </div>

                <!-- Invitations List -->
                <div id="invitations-list" class="space-y-4">
                    ${this.renderGroupedInvitations(groupedInvitations)}
                </div>

                <!-- Navigation -->
                <div class="mt-8 flex justify-center">
                    <button onclick="ConditionalInvitations.continueAfterInvitations()"
                            class="px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                        Continue
                    </button>
                </div>
            </div>
        `;
        },

        /**
         * Group invitations by inviter for better UX
         */
        groupInvitationsByInviter(invitations) {
            const grouped = {};

            invitations.forEach(inv => {
                const key = inv.inviter_email;
                if (!grouped[key]) {
                    grouped[key] = {
                        inviterName: inv.inviter_name,
                        inviterEmail: inv.inviter_email,
                        invitations: []
                    };
                }
                grouped[key].invitations.push(inv);
            });

            return grouped;
        },

        /**
         * Render grouped invitations
         */
        renderGroupedInvitations(groupedInvitations) {
            return Object.values(groupedInvitations).map(group => `
            <div class="bg-white rounded-xl shadow-lg p-6 border border-pastel-light">
                <!-- Inviter Info -->
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="font-semibold text-lg text-pastel-heading">
                            ${onboardingApp.utils.escapeHtml(group.inviterName)}
                        </h3>
                        <p class="text-sm text-pastel-textLight">
                            ${onboardingApp.utils.escapeHtml(group.inviterEmail)}
                        </p>
                    </div>
                    ${group.invitations.length > 1 ? `
                        <span class="text-sm text-pastel-primary font-medium">
                            ${group.invitations.length} babies
                        </span>
                    ` : ''}
                </div>

                <!-- Baby Invitations -->
                <div class="space-y-3">
                    ${group.invitations.map(inv => this.renderInvitationCard(inv)).join('')}
                </div>
            </div>
        `).join('');
        },

        /**
         * Render individual invitation card
         */
        renderInvitationCard(invitation) {
            const isProcessed = this.processedInvitations.has(invitation.invitation_id);

            return `
            <div class="p-4 bg-pastel-lightest rounded-lg ${isProcessed ? 'opacity-50' : ''}"
                 data-invitation-id="${invitation.invitation_id}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- Baby Avatar -->
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pastel-secondary to-pastel-accent1 flex items-center justify-center">
                            <span class="text-lg font-serif font-semibold text-white">
                                ${invitation.baby_name.charAt(0).toUpperCase()}
                            </span>
                        </div>

                        <!-- Baby Info -->
                        <div>
                            <h4 class="font-medium text-pastel-heading">
                                ${onboardingApp.utils.escapeHtml(invitation.baby_name)}
                            </h4>
                            <p class="text-xs text-pastel-textLight">
                                Invited ${onboardingApp.utils.formatDateForDisplay(invitation.created_at)}
                            </p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-2">
                        ${!isProcessed ? `
                            <button onclick="ConditionalInvitations.acceptInvitation(${invitation.invitation_id})"
                                    class="px-4 py-2 bg-pastel-primary text-white text-sm font-medium rounded-lg hover:bg-pastel-primaryHover transition-colors">
                                Accept
                            </button>
                            <button onclick="ConditionalInvitations.declineInvitation(${invitation.invitation_id})"
                                    class="px-4 py-2 border border-pastel-light text-pastel-text text-sm font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                                Decline
                            </button>
                        ` : `
                            <span class="text-sm text-pastel-textLight">
                                ${RevisedOnboardingFlow.state.acceptedInvitations.includes(invitation.invitation_id) ? 'Accepted' : 'Declined'}
                            </span>
                        `}
                    </div>
                </div>
            </div>
        `;
        },

        /**
         * Accept a single invitation
         */
        async acceptInvitation(invitationId) {
            try {
                // Update UI immediately
                this.updateInvitationUI(invitationId, 'processing');

                // Make API call
                await onboardingApp.api.endpoints.respondToInvitation(invitationId, true);
                await onboardingApp.api.endpoints.markNotificationAsRead(invitationId);

                // Update state
                RevisedOnboardingFlow.state.acceptedInvitations.push(invitationId);
                this.processedInvitations.add(invitationId);

                // Update UI
                this.updateInvitationUI(invitationId, 'accepted');

                // Remove the invitation name from the validation list
                const invitation = RevisedOnboardingFlow.state.pendingInvitations.find(
                    inv => inv.invitation_id === invitationId
                );
                if (invitation) {
                    const nameIndex = RevisedOnboardingFlow.state.invitedBabyNames.indexOf(
                        invitation.baby_name.toLowerCase().trim()
                    );
                    if (nameIndex > -1) {
                        RevisedOnboardingFlow.state.invitedBabyNames.splice(nameIndex, 1);
                    }
                }

                onboardingApp.ui.showToast('Invitation accepted!', onboardingApp.MESSAGE_TYPES.SUCCESS);

                // Check if all invitations are processed
                this.checkAllProcessed();

            } catch (error) {
                this.updateInvitationUI(invitationId, 'error');
                onboardingApp.ui.showToast('Failed to accept invitation: ' + error.message, onboardingApp.MESSAGE_TYPES.ERROR);
            }
        },

        /**
         * Decline a single invitation
         */
        async declineInvitation(invitationId) {
            try {
                // Update UI immediately
                this.updateInvitationUI(invitationId, 'processing');

                // Make API call
                await onboardingApp.api.endpoints.respondToInvitation(invitationId, false);
                await onboardingApp.api.endpoints.markNotificationAsRead(invitationId);

                // Update state
                this.processedInvitations.add(invitationId);

                // Update UI
                this.updateInvitationUI(invitationId, 'declined');

                // Remove the invitation name from the validation list
                const invitation = RevisedOnboardingFlow.state.pendingInvitations.find(
                    inv => inv.invitation_id === invitationId
                );
                if (invitation) {
                    const nameIndex = RevisedOnboardingFlow.state.invitedBabyNames.indexOf(
                        invitation.baby_name.toLowerCase().trim()
                    );
                    if (nameIndex > -1) {
                        RevisedOnboardingFlow.state.invitedBabyNames.splice(nameIndex, 1);
                    }
                }

                onboardingApp.ui.showToast('Invitation declined', onboardingApp.MESSAGE_TYPES.INFO);

                // Check if all invitations are processed
                this.checkAllProcessed();

            } catch (error) {
                this.updateInvitationUI(invitationId, 'error');
                onboardingApp.ui.showToast('Failed to decline invitation: ' + error.message, onboardingApp.MESSAGE_TYPES.ERROR);
            }
        },

        /**
         * Accept all pending invitations
         */
        async acceptAllInvitations() {
            const unprocessed = RevisedOnboardingFlow.state.pendingInvitations.filter(
                inv => !this.processedInvitations.has(inv.invitation_id)
            );

            if (confirm(`Accept all ${unprocessed.length} pending invitations?`)) {
                for (const invitation of unprocessed) {
                    await this.acceptInvitation(invitation.invitation_id);
                }
            }
        },

        /**
         * Decline all pending invitations
         */
        async declineAllInvitations() {
            const unprocessed = RevisedOnboardingFlow.state.pendingInvitations.filter(
                inv => !this.processedInvitations.has(inv.invitation_id)
            );

            if (confirm(`Decline all ${unprocessed.length} pending invitations?`)) {
                for (const invitation of unprocessed) {
                    await this.declineInvitation(invitation.invitation_id);
                }
            }
        },

        /**
         * Update invitation UI state
         */
        updateInvitationUI(invitationId, state) {
            const invCard = document.querySelector(`[data-invitation-id="${invitationId}"]`);
            if (!invCard) return;

            const buttonsContainer = invCard.querySelector('.flex.items-center.space-x-2');
            if (!buttonsContainer) return;

            switch (state) {
                case 'processing':
                    buttonsContainer.innerHTML = `
                    <div class="flex items-center space-x-2 text-sm text-pastel-textLight">
                        <div class="spinner w-4 h-4"></div>
                        <span>Processing...</span>
                    </div>
                `;
                    break;

                case 'accepted':
                    invCard.classList.add('opacity-50');
                    buttonsContainer.innerHTML = `
                    <span class="text-sm text-green-600 font-medium"> Accepted</span>
                `;
                    break;

                case 'declined':
                    invCard.classList.add('opacity-50');
                    buttonsContainer.innerHTML = `
                    <span class="text-sm text-pastel-textLight">Declined</span>
                `;
                    break;

                case 'error':
                    // Re-enable buttons on error
                    location.reload(); // Simple recovery
                    break;
            }
        },

        /**
         * Check if all invitations have been processed
         */
        checkAllProcessed() {
            const allProcessed = RevisedOnboardingFlow.state.pendingInvitations.every(
                inv => this.processedInvitations.has(inv.invitation_id)
            );

            if (allProcessed) {
                // Auto-continue after a short delay
                setTimeout(() => {
                    this.continueAfterInvitations();
                }, 1500);
            }
        },

        /**
         * Continue to next step after processing invitations
         */
        continueAfterInvitations() {
            RevisedOnboardingFlow.setFlowState(RevisedOnboardingFlow.FLOW_STATES.CHOOSE_ACTION);
        }
    };

    // Enhanced Completion Flow Component
    const CompletionFlow = {
        /**
         * Show the review and complete section
         */
        showReviewCompleteSection() {
            const container = document.getElementById('dynamic-content');
            const summary = this.generateSummary();

            container.innerHTML = `
            <div class="max-w-4xl mx-auto">
                <!-- Success Header -->
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h2 class="font-serif text-3xl text-pastel-heading mb-2">
                        Setup Complete! 
                    </h2>
                    <p class="text-pastel-textLight">
                        Here's a summary of your BabyHelper account
                    </p>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    ${this.renderSummaryCards(summary)}
                </div>

                <!-- Detailed Summary -->
                ${summary.babies.length > 0 || summary.acceptedBabies.length > 0 ? `
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-pastel-light mb-8">
                        <h3 class="font-serif text-xl text-pastel-heading mb-4">Your Babies</h3>

                        <!-- Added Babies -->
                        ${summary.babies.length > 0 ? `
                            <div class="mb-6">
                                <h4 class="font-medium text-pastel-text mb-3">Babies you created:</h4>
                                <div class="space-y-3">
                                    ${summary.babies.map(baby => `
                                        <div class="p-4 bg-pastel-lightest rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-semibold text-pastel-heading">
                                                        ${onboardingApp.utils.escapeHtml(baby.name)}
                                                    </h5>
                                                    <p class="text-sm text-pastel-textLight">
                                                        ${baby.coparents.length} co-parent${baby.coparents.length !== 1 ? 's' : ''} invited
                                                    </p>
                                                </div>
                                                <span class="text-xs text-green-600 font-medium">
                                                    Primary caregiver
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Accepted Invitations -->
                        ${summary.acceptedBabies.length > 0 ? `
                            <div>
                                <h4 class="font-medium text-pastel-text mb-3">Babies you're co-parenting:</h4>
                                <div class="space-y-3">
                                    ${summary.acceptedBabies.map(baby => `
                                        <div class="p-4 bg-pastel-lightest rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-semibold text-pastel-heading">
                                                        ${onboardingApp.utils.escapeHtml(baby.baby_name)}
                                                    </h5>
                                                    <p class="text-sm text-pastel-textLight">
                                                        Invited by ${onboardingApp.utils.escapeHtml(baby.inviter_name)}
                                                    </p>
                                                </div>
                                                <span class="text-xs text-pastel-primary font-medium">
                                                    Co-parent
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Next Steps -->
                <div class="bg-pastel-lightest rounded-xl p-6 mb-8">
                    <h3 class="font-serif text-xl text-pastel-heading mb-4">What's Next?</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${this.getNextSteps(summary).map(step => `
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 rounded-full bg-pastel-primary bg-opacity-20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs text-pastel-primary font-bold">${step.number}</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-pastel-heading">${step.title}</h4>
                                    <p class="text-sm text-pastel-textLight">${step.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="CompletionFlow.goToDashboard()"
                            class="w-full sm:w-auto px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                        Go to Dashboard
                    </button>

                    <div class="flex items-center space-x-3">
                        <input type="checkbox"
                               id="skip-onboarding-checkbox"
                               class="w-4 h-4 text-pastel-primary rounded focus:ring-pastel-primary">
                        <label for="skip-onboarding-checkbox" class="text-sm text-pastel-text">
                            Don't show this setup again
                        </label>
                    </div>
                </div>
            </div>
        `;
        },

        /**
         * Generate summary data
         */
        generateSummary() {
            const acceptedBabies = RevisedOnboardingFlow.state.pendingInvitations.filter(
                inv => RevisedOnboardingFlow.state.acceptedInvitations.includes(inv.invitation_id)
            );

            const totalCoparents = RevisedOnboardingFlow.state.addedBabies.reduce(
                (sum, baby) => sum + baby.coparents.length, 0
            );

            return {
                babies: RevisedOnboardingFlow.state.addedBabies,
                acceptedBabies: acceptedBabies,
                totalBabies: RevisedOnboardingFlow.state.addedBabies.length + acceptedBabies.length,
                totalCoparents: totalCoparents,
                declinedInvitations: ConditionalInvitations.processedInvitations.size - acceptedBabies.length
            };
        },

        /**
         * Render summary cards
         */
        renderSummaryCards(summary) {
            const cards = [
                {
                    icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>`,
                    label: 'Total Babies',
                    value: summary.totalBabies,
                    color: 'pastel-primary'
                },
                {
                    icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>`,
                    label: 'Co-parents Invited',
                    value: summary.totalCoparents,
                    color: 'pastel-accent1'
                },
                {
                    icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
                    label: 'Setup Progress',
                    value: '100%',
                    color: 'green-600'
                }
            ];

            return cards.map(card => `
            <div class="bg-white rounded-xl shadow-lg p-6 border border-pastel-light text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-${card.color} bg-opacity-20 flex items-center justify-center text-${card.color}">
                    ${card.icon}
                </div>
                <p class="text-3xl font-bold text-pastel-heading mb-1">${card.value}</p>
                <p class="text-sm text-pastel-textLight">${card.label}</p>
            </div>
        `).join('');
        },

        /**
         * Get next steps based on user's setup
         */
        getNextSteps(summary) {
            const steps = [];

            if (summary.totalBabies > 0) {
                steps.push({
                    number: 1,
                    title: 'Start Tracking',
                    description: 'Log your first feeding, diaper change, or sleep session'
                });

                if (summary.totalCoparents > 0) {
                    steps.push({
                        number: 2,
                        title: 'Wait for Co-parents',
                        description: 'They\'ll receive invitations to join'
                    });
                } else {
                    steps.push({
                        number: 2,
                        title: 'Ask AI About Your Baby',
                        description: 'Get quick answers and tips about sleep, feeding, and development'
                    });
                }
            } else {
                steps.push({
                    number: 1,
                    title: 'Add a Baby',
                    description: 'Go to Settings to add your first baby'
                });

                steps.push({
                    number: 2,
                    title: 'Invite a Co-parent',
                    description: 'Send an invitation so someone can help track baby care'
                });
            }

            steps.push({
                number: steps.length + 1,
                title: 'Explore Features',
                description: 'Check out growth charts, reports, and insights'
            });

            steps.push({
                number: steps.length + 1,
                title: 'Customize Settings',
                description: 'Update your name, photo, and account details'
            });

            return steps;
        },

        /**
         * Complete setup and go to dashboard
         */
        async goToDashboard() {
            try {
                // Check if user wants to skip onboarding in future
                const skipCheckbox = document.getElementById('skip-onboarding-checkbox');
                if (skipCheckbox && skipCheckbox.checked) {
                    await this.saveSkipPreference();
                }

                // Mark onboarding as complete
                sessionStorage.setItem('onboardingComplete', 'true');

                // Clear any saved progress
                onboardingApp.storage.clearProgress();

                // Show success message
                onboardingApp.ui.showToast('Welcome to BabyHelper! Redirecting...', onboardingApp.MESSAGE_TYPES.SUCCESS);

                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1500);

            } catch (error) {
                console.error('Error completing setup:', error);
                onboardingApp.ui.showToast('Completing setup... Redirecting to dashboard', onboardingApp.MESSAGE_TYPES.INFO);

                // Redirect anyway after error
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        },

        /**
         * Save skip preference
         */
        async saveSkipPreference() {
            try {
                await onboardingApp.api.endpoints.updateUserPreference({skip_onboarding: true});
                sessionStorage.setItem('skipOnboarding', 'true');
            } catch (error) {
                console.error('Failed to save skip preference:', error);
                // Continue anyway - not critical
            }
        }
    };

    // Wait for all components to be loaded
    window.addEventListener('DOMContentLoaded', () => {
        // Initialize the revised flow
        RevisedOnboardingFlow.initializeFlow().catch(error => {
            console.error('Failed to initialize onboarding:', error);
            onboardingApp.ui.showToast('Error loading setup. Please refresh the page.', onboardingApp.MESSAGE_TYPES.ERROR);
        });

        // Initialize validators
        BabyNameValidator.init();
        onboardingApp.init();

        // Set up global error handling
        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled promise rejection:', event.reason);
            onboardingApp.ui.showToast('An unexpected error occurred. Please try again.', onboardingApp.MESSAGE_TYPES.ERROR);
        });
    });
</script>
</body>
</html>