<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to BabyHelper - Onboarding</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700&family=Lora:wght@400;500;600&display=swap"
          rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            lightest: '#fdf6f0',
                            light: '#ffe8d9',
                            primary: '#ff8c69',
                            primaryHover: '#ff7043',
                            secondary: '#ffd8cc',
                            accent1: '#ffb5a7',
                            accent2: '#fec89a',
                            text: '#6d5d52',
                            textLight: '#938278',
                            heading: '#5c4d44'
                        }
                    },
                    fontFamily: {
                        sans: ['Nunito Sans', 'sans-serif'],
                        serif: ['Lora', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Step transition animations */
        .step-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .step-hidden {
            display: none;
        }

        .step-inactive {
            opacity: 0;
            transform: translateX(20px);
        }

        .progress-segment {
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-pastel-lightest font-sans text-pastel-text min-h-screen">
<!-- Header -->
<nav class="w-full py-4 px-4 md:px-8 bg-white shadow-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <a href="#" class="flex items-center space-x-2">
            <div class="w-10 h-10 rounded-full bg-pastel-primary flex items-center justify-center text-white font-serif font-semibold text-xl">
                B
            </div>
            <span class="font-serif text-pastel-heading text-xl">BabyHelper</span>
        </a>
        <div class="flex items-center space-x-4">
            <img id="userPicture" class="w-10 h-10 rounded-full">
            <button onclick="logout()"
                    class="text-sm text-pastel-textLight hover:text-pastel-primary transition-colors">Logout
            </button>
        </div>
    </div>
</nav>

<!-- Onboarding Content -->
<div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Welcome Section -->
    <div class="text-center mb-8">
        <h1 class="font-serif text-4xl md:text-5xl font-medium text-pastel-heading mb-4">
            Welcome to BabyHelper, <span id="userName" class="text-pastel-primary">Parent</span>!
        </h1>
        <p class="text-lg text-pastel-textLight">
            Let's get your account set up. You can skip any step and complete it later in settings.
        </p>
        <p class="text-sm text-pastel-textLight mt-2">
            Signed in as: <span id="userEmail" class="font-medium"></span>
        </p>
    </div>

    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-pastel-textLight">Step <span id="currentStepNumber">1</span> of 3</span>
            <button onclick="skipAllSteps()"
                    class="text-sm text-pastel-primary hover:text-pastel-primaryHover font-medium transition-colors">
                Skip All Steps â†’
            </button>
        </div>
        <div class="w-full bg-pastel-light rounded-full h-2 flex space-x-1">
            <div id="progress-1" class="progress-segment flex-1 bg-pastel-primary rounded-full"></div>
            <div id="progress-2" class="progress-segment flex-1 bg-pastel-light rounded-full"></div>
            <div id="progress-3" class="progress-segment flex-1 bg-pastel-light rounded-full"></div>
        </div>
    </div>

    <!-- Step 1: Baby Information -->
    <div id="step-1" class="step-container">
        <div class="bg-white rounded-2xl shadow-lg p-8 border border-pastel-light">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-pastel-primary flex items-center justify-center text-white font-semibold text-lg">
                        1
                    </div>
                    <h2 class="font-serif text-2xl text-pastel-heading ml-4">Add Your Baby's Information</h2>
                </div>
                <button onclick="skipCurrentStep()"
                        class="text-sm text-pastel-textLight hover:text-pastel-text transition-colors">
                    Skip This Step
                </button>
            </div>

            <form id="babyInfoForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-pastel-text mb-2">Baby's Name</label>
                        <input type="text" id="babyName" placeholder="Emma"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-pastel-text mb-2">Date of Birth</label>
                        <input type="date" id="babyDob"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-pastel-text mb-2">Gender</label>
                        <select id="babyGender"
                                class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-pastel-text mb-2">Current Weight (kg)</label>
                        <input type="number" id="babyWeight" step="0.1" placeholder="3.2"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-pastel-text mb-2">Baby's Name</label>
                        <input type="text" id="babyHeight" placeholder="49.2"
                               class="w-full px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" onclick="nextStep()"
                            class="px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                        Next Step
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Step 2: Co-parenting Setup -->
    <div id="step-2" class="step-container step-hidden">
        <div class="bg-white rounded-2xl shadow-lg p-8 border border-pastel-light">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-pastel-accent2 flex items-center justify-center text-white font-semibold text-lg">
                        2
                    </div>
                    <h2 class="font-serif text-2xl text-pastel-heading ml-4">Invite a Co-parent</h2>
                </div>
                <button onclick="skipCurrentStep()"
                        class="text-sm text-pastel-textLight hover:text-pastel-text transition-colors">
                    Skip This Step
                </button>
            </div>

            <!-- Benefits -->
            <div class="bg-pastel-lightest rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-pastel-heading mb-3">Benefits of Co-parenting</h3>
                <div class="space-y-2">
                    <div class="flex items-start space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pastel-primary mt-0.5 flex-shrink-0"
                             viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                  clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm text-pastel-text">Share baby care responsibilities with your partner</p>
                    </div>
                    <div class="flex items-start space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pastel-primary mt-0.5 flex-shrink-0"
                             viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                  clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm text-pastel-text">Real-time syncing keeps everyone updated</p>
                    </div>
                </div>
            </div>

            <form id="coParentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-pastel-text mb-2">Co-parent's Email</label>
                    <div class="flex space-x-2">
                        <input type="email" id="coParentEmail" placeholder="partner@example.com"
                               class="flex-1 px-4 py-2 border border-pastel-light rounded-lg focus:outline-none focus:ring-2 focus:ring-pastel-primary">
                        <button type="button" onclick="nextStep()"
                                class="px-6 py-2 bg-pastel-secondary text-pastel-primary font-medium rounded-lg hover:bg-pastel-accent1 hover:text-white transition-colors">
                            Send Invite
                        </button>
                    </div>
                </div>

                <!-- Invited List -->
                <div id="invitedList" class="hidden">
                    <h3 class="font-semibold text-pastel-heading mb-2">Pending Invitations</h3>
                    <div id="invitationsList" class="space-y-2">
                        <!-- Invitations will be dynamically added here -->
                    </div>
                </div>
            </form>

            <div class="flex justify-between mt-8">
                <button type="button" onclick="previousStep()"
                        class="px-6 py-3 border border-pastel-light text-pastel-text font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                    Previous
                </button>
                <button type="button" onclick="skipCurrentStep()"
                        class="px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                    Next Step
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: Check Co-parent Invitations -->
    <div id="step-3" class="step-container step-hidden">
        <div class="bg-white rounded-2xl shadow-lg p-8 border border-pastel-light">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-pastel-accent1 flex items-center justify-center text-white font-semibold text-lg">
                        3
                    </div>
                    <h2 class="font-serif text-2xl text-pastel-heading ml-4">Co-parent Invitations</h2>
                </div>
                <button onclick="skipCurrentStep()"
                        class="text-sm text-pastel-textLight hover:text-pastel-text transition-colors">
                    Skip This Step
                </button>
            </div>

            <p class="text-pastel-text mb-6">
                Check if you have any pending invitations to be a co-parent for another user's baby.
            </p>

            <!-- Loading State -->
            <div id="invitationsLoading" class="text-center py-8">
                <div class="inline-flex items-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-pastel-primary" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-pastel-textLight">Checking for invitations...</span>
                </div>
            </div>

            <!-- No Invitations State -->
            <div id="noInvitations" class="hidden text-center py-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-pastel-light mx-auto mb-4" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
                <p class="text-pastel-textLight">No pending invitations at this time.</p>
            </div>

            <!-- Invitations List -->
            <div id="pendingInvitations" class="hidden space-y-4">
                <!-- Invitations will be dynamically loaded here -->
            </div>

            <div class="flex justify-between mt-8">
                <button type="button" onclick="previousStep()"
                        class="px-6 py-3 border border-pastel-light text-pastel-text font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                    Previous
                </button>
                <button type="button" onclick="completeOnboarding()"
                        class="px-8 py-3 bg-pastel-primary text-white font-semibold rounded-lg hover:bg-pastel-primaryHover transition-colors">
                    Complete Setup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Features Preview -->
<div id="featuresPreview" class="bg-white py-16 mt-16">
    <div class="max-w-6xl mx-auto px-4">
        <h3 class="font-serif text-3xl text-pastel-heading text-center mb-12">
            What You Can Do with BabyHelper
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-pastel-lightest flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-pastel-primary" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h4 class="font-semibold text-lg text-pastel-heading mb-2">Track Everything</h4>
                <p class="text-pastel-textLight">Log feedings, diaper changes, sleep times, and more with just a
                    tap.</p>
            </div>

            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-pastel-lightest flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-pastel-accent1" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <h4 class="font-semibold text-lg text-pastel-heading mb-2">View Insights</h4>
                <p class="text-pastel-textLight">See patterns and trends in your baby's routine to better understand
                    their needs.</p>
            </div>

            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-pastel-lightest flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-pastel-accent2" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
                <h4 class="font-semibold text-lg text-pastel-heading mb-2">Share Care</h4>
                <p class="text-pastel-textLight">Collaborate with partners and caregivers for seamless baby care
                    coordination.</p>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * Onboarding State Management
     * Tracks current step, form data, and manages step transitions
     */
    const onboardingState = {
        currentStep: 1,
        totalSteps: 3,
        data: {
            babyInfo: {},
            coParents: [],
            acceptedInvitations: []
        }
    };

    /**
     * Initialize onboarding on page load
     * Checks authentication and loads user data
     */
    window.addEventListener('DOMContentLoaded', function () {
        // Check authentication
        const idToken = sessionStorage.getItem('idToken');
        const userEmail = sessionStorage.getItem('userEmail');
        const userName = sessionStorage.getItem('userName');
        const userPicture = sessionStorage.getItem('userPicture');

        if (!idToken) {
            window.location.href = '/';
            return;
        }

        // Display user information
        if (userName) document.getElementById('userName').textContent = userName;
        if (userEmail) document.getElementById('userEmail').textContent = userEmail;
        if (userPicture) document.getElementById('userPicture').src = userPicture;

        window.authToken = idToken;

        // Initialize first step
        showStep(1);

        // Load any saved progress from sessionStorage
        loadSavedProgress();
    });

    /**
     * Load saved onboarding progress from sessionStorage
     * Allows users to resume where they left off
     */
    function loadSavedProgress() {
        const savedProgress = sessionStorage.getItem('onboardingProgress');
        if (savedProgress) {
            const progress = JSON.parse(savedProgress);
            onboardingState.data = progress;

            // Pre-fill forms with saved data
            if (progress.babyInfo) {
                document.getElementById('babyName').value = progress.babyInfo.name || '';
                document.getElementById('babyDob').value = progress.babyInfo.dob || '';
                document.getElementById('babyGender').value = progress.babyInfo.gender || '';
                document.getElementById('babyWeight').value = progress.babyInfo.weight || '';
                document.getElementById('babyHeight').value = progress.babyInfo.height || '';
            }
        }
    }

    /**
     * Save current progress to sessionStorage
     * Ensures users don't lose data if they navigate away
     */
    function saveProgress() {
        sessionStorage.setItem('onboardingProgress', JSON.stringify(onboardingState.data));
    }

    /**
     * Show specific step and hide others
     * @param {number} stepNumber - The step to display (1-3)
     */
    function showStep(stepNumber) {
        // Update state
        onboardingState.currentStep = stepNumber;

        // Update step number display
        document.getElementById('currentStepNumber').textContent = stepNumber;

        // Update progress bar
        for (let i = 1; i <= onboardingState.totalSteps; i++) {
            const segment = document.getElementById(`progress-${i}`);
            if (i <= stepNumber) {
                segment.classList.add('bg-pastel-primary');
                segment.classList.remove('bg-pastel-light');
            } else {
                segment.classList.remove('bg-pastel-primary');
                segment.classList.add('bg-pastel-light');
            }
        }

        // Show/hide steps with animation
        for (let i = 1; i <= onboardingState.totalSteps; i++) {
            const step = document.getElementById(`step-${i}`);
            if (i === stepNumber) {
                step.classList.remove('step-hidden', 'step-inactive');

                // Special handling for step 3 - load invitations
                if (i === 3) {
                    loadPendingInvitations();
                }
            } else {
                step.classList.add('step-hidden');
            }
        }
    }

    /**
     * Navigate to the next step
     * Saves current step data before proceeding
     */
    async function nextStep() {
        // Early return if already at the last step
        if (onboardingState.currentStep >= onboardingState.totalSteps) {
            return;
        }

        // Save current step data based on step number
        const saveOperations = {
            1: saveBabyInfo,
            2: sendInvite
            // 3: savePreferences,
        };

        const saveFunction = saveOperations[onboardingState.currentStep];

        if (saveFunction) {
            try {
                await saveFunction();
            } catch (error) {
                // Handle different error types
                const errorMessage = error.message || 'An error occurred while saving data';

                alert(`Notice: ${errorMessage}`);

                // Log error for debugging
                console.error('Save operation failed:', error);

                // Exit early - don't proceed to next step
                return;
            }
        }

        if (onboardingState.currentStep === 2) {
            return;
        }
        // Only proceed if save was successful (or no save was needed, or not step 2)
        showStep(onboardingState.currentStep + 1);
    }

    /**
     * Navigate to the previous step
     */
    function previousStep() {
        if (onboardingState.currentStep > 1) {
            showStep(onboardingState.currentStep - 1);
        }
    }

    /**
     * Skip the current step and move to the next
     * If on last step, complete onboarding
     */
    function skipCurrentStep() {
        if (onboardingState.currentStep < onboardingState.totalSteps) {
            showStep(onboardingState.currentStep + 1);
        } else {
            completeOnboarding();
        }
    }

    /**
     * Skip all remaining steps and complete onboarding
     * Shows confirmation before proceeding
     */
    function skipAllSteps() {
        if (confirm('Are you sure you want to skip all steps? You can complete these later in settings.')) {
            completeOnboarding();
        }
    }


    /**
     * Get the authentication token from storage
     * @returns {string|null} The authentication token or null if not found
     */
    function getAuthToken() {
        return sessionStorage.getItem('idToken') || window.authToken || null;
    }

    /**
     * Get default headers for API requests
     * @returns {Object} Headers object with authentication
     */
    function getApiHeaders() {
        const token = getAuthToken();
        if (!token) {
            throw new Error('No authentication token found');
        }

        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
    }

    /**
     * Make an authenticated API request
     * @param {string} url - The API endpoint
     * @param {Object} options - Fetch options
     * @returns {Promise<Response>} The fetch response
     */
    async function authenticatedFetch(url, options = {}) {
        try {
            const headers = getApiHeaders();
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...headers,
                    ...options.headers
                }
            });

            // Handle 401/403 globally
            if (response.status === 401 || response.status === 403) {
                sessionStorage.clear();
                window.location.href = '/auth/login';
                throw new Error('Authentication expired. Redirecting to login...');
            }

            return response;
        } catch (error) {
            console.error('API request failed:', error);
            throw error;
        }
    }

    /**
     * Format date to YYYY-MM-DD format expected by backend
     * @param {string} dateString - Date in any format
     * @returns {string} Date in YYYY-MM-DD format
     */
    function formatDateForAPI(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    /**
     * Save baby data to the backend
     */
    async function saveBabyData(name, dob, gender, weight, height) {

        // Format the date properly
        const formattedDob = formatDateForAPI(dob);

        // Prepare the payload
        const payload = {
            fullname: name.trim(),
            birthdate: formattedDob,
            sex: gender
        };

        // Only add weight and height if they have values
        if (weight && !isNaN(parseFloat(weight))) {
            payload.weight = parseFloat(weight);
        }
        if (height && !isNaN(parseFloat(height))) {
            payload.height = parseFloat(height);
        }

        const response = await authenticatedFetch('/baby/', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            let errorMessage = 'Failed to save baby information';

            try {
                const errorData = await response.json();
                console.error('Error response:', errorData); // Debug log

                // Handle different error formats from FastAPI
                if (errorData.detail) {
                    if (typeof errorData.detail === 'string') {
                        errorMessage = errorData.detail;
                    } else if (Array.isArray(errorData.detail)) {
                        // Validation errors from FastAPI
                        errorMessage = errorData.detail.map(err => {
                            const field = err.loc ? err.loc[err.loc.length - 1] : 'field';
                            return `${field}: ${err.msg}`;
                        }).join(', ');
                    }
                } else if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // If error response is not JSON
                errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }

            if (response.status === 409) {
                throw new Error('Baby already exists with this name and birthdate');
            } else if (response.status === 422) {
                throw new Error(`Validation error: ${errorMessage}`);
            } else {
                throw new Error(errorMessage);
            }
        }

        const savedBaby = await response.json();

        // Save to onboarding state
        onboardingState.data.babyInfo = {
            baby_id: savedBaby.id,
            name: savedBaby.fullname,
            dob: savedBaby.birthdate,
            gender: savedBaby.sex,
            weight: savedBaby.weight,
            height: savedBaby.height,
        };
        saveProgress();

        return savedBaby;


    }

    /**
     * Save baby information from Step 1
     */
    async function saveBabyInfo() {
        const babyName = document.getElementById('babyName').value;
        const babyDob = document.getElementById('babyDob').value;
        const babyGender = document.getElementById('babyGender').value;
        const babyWeight = document.getElementById('babyWeight').value;
        const babyHeight = document.getElementById('babyHeight').value;
        if (!babyName || !babyDob || !babyGender || !babyWeight || !babyHeight) {
            throw new Error('All baby fields are not entered');
        }

        await saveBabyData(babyName, babyDob, babyGender, babyWeight, babyHeight);


    }

    /**
     * Send co-parent invitation
     * Validates email and adds to invitation list
     */
    async function sendInvite() {
        // Check if baby info exists in the state object
        if (!onboardingState.data.babyInfo || Object.keys(onboardingState.data.babyInfo).length === 0) {
            throw new Error('To add co-parent to your baby, please enter your baby information in the previous step. Or skip this step.');
        }

        const emailInput = document.getElementById('coParentEmail');
        const email = emailInput.value.trim();

        if (!email) {
            throw new Error('Please enter an email address');
        }
        if (email === sessionStorage.getItem('userEmail')) {
            throw new Error('Please enter an email address that is not yours');
        }

        // Gmail-only email validation
        const gmailRegex = /^[a-zA-Z0-9.+_-]+@gmail\.com$/;
        if (!gmailRegex.test(email)) {
            throw new Error('Please enter a valid Gmail address');
        }

        // Check if already invited
        if (onboardingState.data.coParents.includes(email)) {
            throw new Error('This person has already been invited');
        }

        const payload = {
            baby_id: onboardingState.data.babyInfo.baby_id,
            email: email
        }

        const response = await authenticatedFetch('/coparent/invite/', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            let errorMessage = 'Failed to send invitation';

            try {
                const errorData = await response.json();
                console.error('Error response:', errorData); // Debug log

                // Handle different error formats from FastAPI
                if (errorData.detail) {
                    if (typeof errorData.detail === 'string') {
                        errorMessage = errorData.detail;
                    } else if (Array.isArray(errorData.detail)) {
                        // Validation errors from FastAPI
                        errorMessage = errorData.detail.map(err => {
                            const field = err.loc ? err.loc[err.loc.length - 1] : 'field';
                            return `${field}: ${err.msg}`;
                        }).join(', ');
                    }
                } else if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // If error response is not JSON
                errorMessage = `HTTP ${response.status}: ${response.statusText[1]}`;
            }

            throw new Error(errorMessage);
        }

        // Add to invitations
        onboardingState.data.coParents.push(email);
        saveProgress();

        // Update UI
        updateInvitationsList();
        emailInput.value = '';

        // Show success message
        showToast('Invitation sent successfully!');
    }

    /**
     * Update the displayed list of sent invitations
     */
    function updateInvitationsList() {
        const listContainer = document.getElementById('invitedList');
        const invitationsList = document.getElementById('invitationsList');

        if (onboardingState.data.coParents.length > 0) {
            listContainer.classList.remove('hidden');

            invitationsList.innerHTML = onboardingState.data.coParents.map(email => `
                    <div class="flex items-center justify-between p-3 bg-pastel-lightest rounded-lg">
                        <span class="text-sm text-pastel-text">${email}</span>
                        <button onclick="removeInvitation('${email}')" class="text-sm text-red-500 hover:text-red-700">
                            Remove
                        </button>
                    </div>
                `).join('');
        } else {
            listContainer.classList.add('hidden');
        }
    }

    /**
     * Remove an invitation
     * @param {string} email - Email to remove from invitations
     */
    function removeInvitation(email) {
        onboardingState.data.coParents = onboardingState.data.coParents.filter(e => e !== email);
        saveProgress();
        updateInvitationsList();
    }


    // Constants for better maintainability
    const INVITATION_STATES = {
        LOADING: 'loading',
        EMPTY: 'empty',
        LOADED: 'loaded',
        ERROR: 'error'
    };


    /**
     * Load and display pending co-parent invitations (Step 3)
     * @returns {Promise<void>}
     */
    async function loadPendingInvitations() {
        const elements = {
            loading: document.getElementById('invitationsLoading'),
            noInvitations: document.getElementById('noInvitations'),
            invitations: document.getElementById('pendingInvitations')
        };

        // Validate required elements exist
        if (!elements.loading || !elements.noInvitations || !elements.invitations) {
            console.error('Required DOM elements not found');
            return;
        }

        setInvitationState(elements, INVITATION_STATES.LOADING);

        try {
            const invitations = await fetchPendingInvitations();

            if (invitations.length > 0) {
                displayInvitations(elements.invitations, invitations);
                setInvitationState(elements, INVITATION_STATES.LOADED);
            } else {
                setInvitationState(elements, INVITATION_STATES.EMPTY);
            }
        } catch (error) {
            console.error('Error loading invitations:', error);
            displayError(elements.noInvitations, error.message);
            setInvitationState(elements, INVITATION_STATES.ERROR);
        }
    }

    /**
     * Fetch pending invitations from the API
     * @returns {Promise<Array>}
     */
    async function fetchPendingInvitations() {
        // Add loading delay for better UX
        await new Promise(resolve => setTimeout(resolve, 1500));

        const response = await authenticatedFetch('/coparent/invitations/', {
            method: 'GET'
        });

        if (!response.ok) {
            throw new Error(await parseErrorResponse(response));
        }

        return response.json();
    }

    /**
     * Parse error response from API
     * @param {Response} response
     * @returns {Promise<string>}
     */
    async function parseErrorResponse(response) {
        let errorMessage = `Failed to load invitations (${response.status})`;

        try {
            const errorData = await response.json();

            if (errorData.detail) {
                if (typeof errorData.detail === 'string') {
                    errorMessage = errorData.detail;
                } else if (Array.isArray(errorData.detail)) {
                    errorMessage = errorData.detail
                        .map(err => {
                            const field = err.loc?.[err.loc.length - 1] || 'field';
                            return `${field}: ${err.msg}`;
                        })
                        .join(', ');
                }
            } else if (errorData.message) {
                errorMessage = errorData.message;
            }
        } catch (e) {
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }

        return errorMessage;
    }

    /**
     * Update UI state based on invitation loading status
     * @param {Object} elements
     * @param {string} state
     */
    function setInvitationState(elements, state) {
        // Hide all elements first
        Object.values(elements).forEach(el => el.classList.add('hidden'));

        // Show relevant element based on state
        switch (state) {
            case INVITATION_STATES.LOADING:
                elements.loading.classList.remove('hidden');
                break;
            case INVITATION_STATES.EMPTY:
            case INVITATION_STATES.ERROR:
                elements.noInvitations.classList.remove('hidden');
                break;
            case INVITATION_STATES.LOADED:
                elements.invitations.classList.remove('hidden');
                break;
        }
    }

    /**
     * Display invitations in the UI
     * @param {HTMLElement} container
     * @param {Array} invitations
     */
    function displayInvitations(container, invitations) {
        container.innerHTML = invitations
            .map(inv => createInvitationHTML(inv))
            .join('');
    }

    /**
     * Create HTML for a single invitation
     * @param {Object} invitation
     * @returns {string}
     */
    function createInvitationHTML(invitation) {
        // Sanitize data to prevent XSS
        const safe = {
            inviterName: escapeHtml(invitation.inviter_name || 'Unknown'),
            inviterEmail: escapeHtml(invitation.inviter_email),
            babyName: escapeHtml(invitation.baby_name),
            createdAt: formatDate(invitation.created_at),
            invitationId: parseInt(invitation.invitation_id, 10)
        };

        return `
        <div class="border border-pastel-light rounded-lg p-4 space-y-3" data-invitation-id="${safe.invitationId}">
            <div class="flex items-start justify-between">
                <div>
                    <h4 class="font-semibold text-pastel-heading">${safe.inviterName}</h4>
                    <p class="text-sm text-pastel-textLight">${safe.inviterEmail}</p>
                </div>
                <span class="text-xs text-pastel-textLight">${safe.createdAt}</span>
            </div>
            <p class="text-sm text-pastel-text">
                Invites you to be a co-parent for <span class="font-medium">${safe.babyName}</span>
            </p>
            <div class="flex space-x-2">
                <button onclick="respondInvitation(${safe.invitationId}, true, '${safe.inviterEmail}', '${safe.babyName}')"
                        class="invitation-accept px-4 py-2 bg-pastel-primary text-white text-sm font-medium rounded-lg hover:bg-pastel-primaryHover transition-colors">
                    Accept
                </button>
                <button onclick="respondInvitation(${safe.invitationId}, false, '${safe.inviterEmail}', '${safe.babyName}')"
                        class="invitation-decline px-4 py-2 border border-pastel-light text-pastel-text text-sm font-medium rounded-lg hover:bg-pastel-lightest transition-colors">
                    Decline
                </button>
            </div>
        </div>
    `;
    }

    /**
     * Display error message to user
     * @param {HTMLElement} container
     * @param {string} message
     */
    function displayError(container, message) {
        container.innerHTML = `
        <p class="text-pastel-textLight">Unable to load invitations</p>
        <p class="text-sm text-red-500 mt-2">${escapeHtml(message)}</p>
        <button onclick="loadPendingInvitations()"
                class="mt-3 text-sm text-pastel-primary hover:underline">
            Try again
        </button>
    `;
    }

    /**
     * Format date for display
     * @param {string} dateString
     * @returns {string}
     */
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        } catch (e) {
            return 'Invalid date';
        }
    }

    /**
     * Escape HTML to prevent XSS attacks
     * @param {string} unsafe
     * @returns {string}
     */
    function escapeHtml(unsafe) {
        const div = document.createElement('div');
        div.textContent = unsafe;
        return div.innerHTML;
    }

    /**
     * Accept or decline a co-parent invitation
     * @param {int} invitationId - ID of the invitation to decline
     * @param {boolean} respond - Accept or reject
     * @param {string} inviterEmail - Email of the inviter
     * @param {string} babyName - Baby name
     */
    async function respondInvitation(invitationId, respond, inviterEmail, babyName) {
        const payload = {
            invitation_id: invitationId,
            accept: respond
        };
        const response = await authenticatedFetch('/coparent/invitations/' + invitationId, {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            throw new Error(await parseErrorResponse(response));
        }

        onboardingState.data.acceptedInvitations.push(invitationId);
        saveProgress();
        if (respond)
            showToast('Invitation from ' + inviterEmail + 'for baby ' + babyName + ' accepted!');
        else
            showToast('Invitation from ' + inviterEmail + 'for baby ' + babyName + ' declined!');

        // Reload invitations to update UI
        await loadPendingInvitations();
    }

    /**
     * Complete the onboarding process
     * Saves all data and redirects to dashboard
     */
    async function completeOnboarding() {
        try {
            // Clear onboarding progress from sessionStorage
            sessionStorage.removeItem('onboardingProgress');

            // Mark onboarding as complete
            sessionStorage.setItem('onboardingComplete', 'true');

            // Show success message
            alert('Welcome to BabyHelper!');

            // Redirect to dashboard
            // window.location.href = '/dashboard';
        } catch (error) {
            console.error('Error completing onboarding:', error);
            alert('There was an error setting up your account. Please try again.');
        }
    }

    /**
     * Logout user and clear session
     */
    function logout() {
        sessionStorage.clear();
        window.location.href = '/';
    }

    /**
     * Utility function to show toast notifications
     * @param {string} message - Message to display
     */
    function showToast(message) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-pastel-heading text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
        toast.textContent = message;

        document.body.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

</script>
</body>
</html>